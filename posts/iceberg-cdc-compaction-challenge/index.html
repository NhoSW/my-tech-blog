<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>Iceberg - Why CDC Table Compaction Is So Tricky &#183; nanta - Data Engineering</title><meta name=title content="Iceberg - Why CDC Table Compaction Is So Tricky &#183; nanta - Data Engineering"><meta name=description content="Iceberg v2's row-level delete implementation, the difference between position and equality deletes, and why compaction commits keep failing when a real-time CDC sink is running. Covers how v3 Deletion Vectors change the picture and the workaround we settled on for v2 in production."><meta name=keywords content="iceberg,cdc,compaction,lakehouse,kafka-connect,deletion-vector,iceberg-v3,"><link rel=canonical href=https://nanta-data.dev/posts/iceberg-cdc-compaction-challenge/><meta name=author content="nanta"><link href=https://github.com/NhoSW rel=me><meta property="og:url" content="https://nanta-data.dev/posts/iceberg-cdc-compaction-challenge/"><meta property="og:site_name" content="nanta - Data Engineering"><meta property="og:title" content="Iceberg - Why CDC Table Compaction Is So Tricky"><meta property="og:description" content="Iceberg v2’s row-level delete implementation, the difference between position and equality deletes, and why compaction commits keep failing when a real-time CDC sink is running. Covers how v3 Deletion Vectors change the picture and the workaround we settled on for v2 in production."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2026-02-24T00:00:00+00:00"><meta property="article:modified_time" content="2026-02-24T00:00:00+00:00"><meta property="article:tag" content="Iceberg"><meta property="article:tag" content="Cdc"><meta property="article:tag" content="Compaction"><meta property="article:tag" content="Lakehouse"><meta property="article:tag" content="Kafka-Connect"><meta property="article:tag" content="Deletion-Vector"><meta name=twitter:card content="summary"><meta name=twitter:title content="Iceberg - Why CDC Table Compaction Is So Tricky"><meta name=twitter:description content="Iceberg v2’s row-level delete implementation, the difference between position and equality deletes, and why compaction commits keep failing when a real-time CDC sink is running. Covers how v3 Deletion Vectors change the picture and the workaround we settled on for v2 in production."><link type=text/css rel=stylesheet href=/css/main.bundle.min.c14e86e0d9a09802d254d2a15c05847ae65bfc2e98c2166fabc67369d2d7f2eae6c1da03bbba58cfd41a4af802147c75ce9fdc11dd724ac627ab2903942cbb79.css integrity="sha512-wU6G4NmgmALSVNKhXAWEeuZb/C6YwhZvq8ZzadLX8urmwdoDu7pYz9QaSvgCFHx1zp/cEd1ySsYnqykDlCy7eQ=="><script type=text/javascript src=/js/appearance.min.6f41174b3a05b680820fe08cadbfa5fb7a7ca347b76a0955cdc68b9d8aca1ce24f0547e138cea33bcc7904d551a90afcb1cc7f2d9fe8557075d501419046c08c.js integrity="sha512-b0EXSzoFtoCCD+CMrb+l+3p8o0e3aglVzcaLnYrKHOJPBUfhOM6jO8x5BNVRqQr8scx/LZ/oVXB11QFBkEbAjA=="></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.bdda7dece6cbaf08deef7d254f7f842f3261c2524d247905127c9a20decc03f1011a2950048464c79272c1ce0705a49a41147f39f2b95163bb71d404b33263ef.js integrity="sha512-vdp97ObLrwje730lT3+ELzJhwlJNJHkFEnyaIN7MA/EBGilQBIRkx5Jywc4HBaSaQRR/OfK5UWO7cdQEszJj7w==" data-copy=Copy data-copied=Copied></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"Iceberg - Why CDC Table Compaction Is So Tricky","headline":"Iceberg - Why CDC Table Compaction Is So Tricky","inLanguage":"en","url":"https://nanta-data.dev/posts/iceberg-cdc-compaction-challenge/","author":{"@type":"Person","name":"nanta"},"copyrightYear":"2026","dateCreated":"2026-02-24T00:00:00\u002b00:00","datePublished":"2026-02-24T00:00:00\u002b00:00","dateModified":"2026-02-24T00:00:00\u002b00:00","keywords":["iceberg","cdc","compaction","lakehouse","kafka-connect","deletion-vector","iceberg-v3"],"mainEntityOfPage":"true","wordCount":"1963"}]</script><link rel=preconnect href=https://cdn.jsdelivr.net crossorigin><link href=https://cdn.jsdelivr.net/npm/geist@1.3.1/dist/fonts/geist-sans/style.min.css rel=stylesheet><link href=https://cdn.jsdelivr.net/npm/geist@1.3.1/dist/fonts/geist-mono/style.min.css rel=stylesheet></head><body class="flex flex-col h-screen m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32 text-lg bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral bf-scrollbar"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 pe-2 dark:text-primary-400">&darr;</span>
Skip to main content</a></div><div class=min-h-[148px]></div><div class="fixed inset-x-0 z-100"><div id=menu-blur class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl bg-neutral/25 dark:bg-neutral-800/25"></div><div class="relative m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32"><div class="main-menu flex items-center w-full gap-2 p-1 pl-0"><a href=/ class="text-base font-medium truncate min-w-0 shrink">nanta - Data Engineering</a><div class="flex items-center ms-auto"><div class="hidden md:flex"><nav class="flex items-center gap-x-5 h-12"><a href=/posts/ class="flex items-center bf-icon-color-hover" aria-label=Posts title=Posts><span class="text-base font-medium break-normal">Posts
</span></a><a href=/categories/ class="flex items-center bf-icon-color-hover" aria-label=Categories title=Categories><span class="text-base font-medium break-normal">Categories
</span></a><a href=/tags/ class="flex items-center bf-icon-color-hover" aria-label=Tags title=Tags><span class="text-base font-medium break-normal">Tags
</span></a><a href=/about/ class="flex items-center bf-icon-color-hover" aria-label=About title=About><span class="text-base font-medium break-normal">About</span></a><div class="translation nested-menu"><button class="cursor-pointer flex items-center">
<span class=me-1><span class="relative block icon"><svg viewBox="0 0 640 512"><path fill="currentColor" d="M0 128C0 92.7 28.7 64 64 64H256h48 16H576c35.3.0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H320 304 256 64c-35.3.0-64-28.7-64-64V128zm320 0V384H576V128H320zM178.3 175.9c-3.2-7.2-10.4-11.9-18.3-11.9s-15.1 4.7-18.3 11.9l-64 144c-4.5 10.1.1 21.9 10.2 26.4s21.9-.1 26.4-10.2l8.9-20.1h73.6l8.9 20.1c4.5 10.1 16.3 14.6 26.4 10.2s14.6-16.3 10.2-26.4l-64-144zM160 233.2 179 276H141l19-42.8zM448 164c11 0 20 9 20 20v4h44 16c11 0 20 9 20 20s-9 20-20 20h-2l-1.6 4.5c-8.9 24.4-22.4 46.6-39.6 65.4.9.6 1.8 1.1 2.7 1.6l18.9 11.3c9.5 5.7 12.5 18 6.9 27.4s-18 12.5-27.4 6.9L467 333.8c-4.5-2.7-8.8-5.5-13.1-8.5-10.6 7.5-21.9 14-34 19.4l-3.6 1.6c-10.1 4.5-21.9-.1-26.4-10.2s.1-21.9 10.2-26.4l3.6-1.6c6.4-2.9 12.6-6.1 18.5-9.8L410 286.1c-7.8-7.8-7.8-20.5.0-28.3s20.5-7.8 28.3.0l14.6 14.6.5.5c12.4-13.1 22.5-28.3 29.8-45H448 376c-11 0-20-9-20-20s9-20 20-20h52v-4c0-11 9-20 20-20z"/></svg></span>
</span><span class="text-sm font-medium bf-icon-color-hover" title="Iceberg - Why CDC Table Compaction Is So Tricky">EN</span></button><ul class=menuhide><li class="rounded-xl backdrop-blur shadow-2xl p-2 flex flex-col gap-1"><a href=/posts/iceberg-cdc-compaction-challenge/ class="flex items-center bf-icon-color-hover px-3 py-1"><span class="text-sm font-sm" title="Iceberg - Why CDC Table Compaction Is So Tricky">English
</span></a><a href=/ko/posts/iceberg-cdc-compaction-challenge/ class="flex items-center bf-icon-color-hover px-3 py-1"><span class="text-sm font-sm" title="Iceberg - 왜 CDC 테이블의 컴팩션이 까다로운가">한국어</span></a></li></ul></div><button id=search-button aria-label=Search class="text-base bf-icon-color-hover" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base bf-icon-color-hover"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav></div><div class="flex md:hidden"><div class="flex items-center h-14 gap-4"><button id=search-button-mobile aria-label=Search class="flex items-center justify-center bf-icon-color-hover" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile type=button aria-label="Dark mode switcher" class="flex items-center justify-center text-neutral-900 hover:text-primary-600 dark:text-neutral-200 dark:hover:text-primary-400"><div class=dark:hidden><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="hidden dark:block"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button>
<input type=checkbox id=mobile-menu-toggle autocomplete=off class="hidden peer">
<label for=mobile-menu-toggle class="flex items-center justify-center cursor-pointer bf-icon-color-hover"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></label><div role=dialog aria-modal=true style=scrollbar-gutter:stable class="fixed inset-0 z-50 invisible overflow-y-auto px-6 py-20 opacity-0 transition-[opacity,visibility] duration-300 peer-checked:visible peer-checked:opacity-100 bg-neutral-50/97 dark:bg-neutral-900/99
bf-scrollbar"><label for=mobile-menu-toggle class="fixed end-8 top-5 flex items-center justify-center z-50 h-12 w-12 cursor-pointer select-none rounded-full bf-icon-color-hover border bf-border-color bf-border-color-hover bg-neutral-50 dark:bg-neutral-900"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></label><nav class="mx-auto max-w-md space-y-6"><div class=px-2><a href=/posts/ aria-label=Posts class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title=Posts class="text-2xl font-bold tracking-tight">Posts</span></a></div><div class=px-2><a href=/categories/ aria-label=Categories class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title=Categories class="text-2xl font-bold tracking-tight">Categories</span></a></div><div class=px-2><a href=/tags/ aria-label=Tags class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title=Tags class="text-2xl font-bold tracking-tight">Tags</span></a></div><div class=px-2><a href=/about/ aria-label=About class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title=About class="text-2xl font-bold tracking-tight">About</span></a></div><div class="flex flex-wrap items-center [&_span]:text-2xl [&_.translation_button_.icon]:text-4xl! [&_.translation_button_span]:text-base! [&_.translation_.menuhide_span]:text-sm! gap-x-6 ps-2 mt-8 pt-8 border-t bf-border-color"><div class="translation nested-menu"><button class="cursor-pointer flex items-center">
<span class=me-1><span class="relative block icon"><svg viewBox="0 0 640 512"><path fill="currentColor" d="M0 128C0 92.7 28.7 64 64 64H256h48 16H576c35.3.0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H320 304 256 64c-35.3.0-64-28.7-64-64V128zm320 0V384H576V128H320zM178.3 175.9c-3.2-7.2-10.4-11.9-18.3-11.9s-15.1 4.7-18.3 11.9l-64 144c-4.5 10.1.1 21.9 10.2 26.4s21.9-.1 26.4-10.2l8.9-20.1h73.6l8.9 20.1c4.5 10.1 16.3 14.6 26.4 10.2s14.6-16.3 10.2-26.4l-64-144zM160 233.2 179 276H141l19-42.8zM448 164c11 0 20 9 20 20v4h44 16c11 0 20 9 20 20s-9 20-20 20h-2l-1.6 4.5c-8.9 24.4-22.4 46.6-39.6 65.4.9.6 1.8 1.1 2.7 1.6l18.9 11.3c9.5 5.7 12.5 18 6.9 27.4s-18 12.5-27.4 6.9L467 333.8c-4.5-2.7-8.8-5.5-13.1-8.5-10.6 7.5-21.9 14-34 19.4l-3.6 1.6c-10.1 4.5-21.9-.1-26.4-10.2s.1-21.9 10.2-26.4l3.6-1.6c6.4-2.9 12.6-6.1 18.5-9.8L410 286.1c-7.8-7.8-7.8-20.5.0-28.3s20.5-7.8 28.3.0l14.6 14.6.5.5c12.4-13.1 22.5-28.3 29.8-45H448 376c-11 0-20-9-20-20s9-20 20-20h52v-4c0-11 9-20 20-20z"/></svg></span>
</span><span class="text-sm font-medium bf-icon-color-hover" title="Iceberg - Why CDC Table Compaction Is So Tricky">EN</span></button><ul class=menuhide><li class="rounded-xl backdrop-blur shadow-2xl p-2 flex flex-col gap-1"><a href=/posts/iceberg-cdc-compaction-challenge/ class="flex items-center bf-icon-color-hover px-3 py-1"><span class="text-sm font-sm" title="Iceberg - Why CDC Table Compaction Is So Tricky">English
</span></a><a href=/ko/posts/iceberg-cdc-compaction-challenge/ class="flex items-center bf-icon-color-hover px-3 py-1"><span class="text-sm font-sm" title="Iceberg - 왜 CDC 테이블의 컴팩션이 까다로운가">한국어</span></a></li></ul></div></div></nav></div></div></div></div></div></div></div><script type=text/javascript src=/js/background-blur.min.605b3b942818f0ab5a717ae446135ec46b8ee5a2ad12ae56fb90dc2a76ce30c388f9fec8bcc18db15bd47e3fa8a09d779fa12aa9c184cf614a315bc72c6c163d.js integrity="sha512-YFs7lCgY8KtacXrkRhNexGuO5aKtEq5W+5DcKnbOMMOI+f7IvMGNsVvUfj+ooJ13n6EqqcGEz2FKMVvHLGwWPQ==" data-blur-id=menu-blur></script><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class=hidden><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/>nanta - Data Engineering</a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/>Posts</a><span class="px-1 text-primary-500">/</span></li><li class=hidden><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/iceberg-cdc-compaction-challenge/>Iceberg - Why CDC Table Compaction Is So Tricky</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Iceberg - Why CDC Table Compaction Is So Tricky</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2026-02-24T00:00:00+00:00>24 February 2026</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">10 mins</span></div></div><div class="flex author"><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">nanta</div><div class="text-sm text-neutral-700 dark:text-neutral-400">Data Engineering blog covering Apache Kafka, Airflow, Trino, StarRocks, and modern data infrastructure. Sharing practical lessons from production.</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/NhoSW target=_blank aria-label=Github title=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span></a></div></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ms-auto px-0 lg:order-last lg:ps-8 lg:max-w-2xs"><div class="toc ps-5 print:hidden lg:sticky lg:top-[140px]"><details open id=TOCView class="toc-right mt-0 overflow-y-auto overscroll-contain bf-scrollbar rounded-lg -ms-5 ps-5 pe-2 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="min-w-[220px] py-2 border-dotted border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#iceberg-v2-row-level-deletes>Iceberg v2 Row-Level Deletes</a><ul><li><a href=#two-ways-to-delete-data-cow-vs-mor>Two Ways to Delete Data: COW vs MOR</a></li><li><a href=#two-kinds-of-delete-files>Two Kinds of Delete Files</a></li><li><a href=#engine-support-varies>Engine Support Varies</a></li></ul></li><li><a href=#the-delta-writer-where-delete-strategy-splits>The Delta Writer: Where Delete Strategy Splits</a></li><li><a href=#snapshot-types-and-commit-conflicts>Snapshot Types and Commit Conflicts</a><ul><li><a href=#four-snapshot-operations>Four Snapshot Operations</a></li><li><a href=#optimistic-concurrency>Optimistic Concurrency</a></li></ul></li><li><a href=#append-only-vs-cdc-why-the-difference>Append-Only vs CDC: Why the Difference</a><ul><li><a href=#append-only-tables-almost-no-conflicts>Append-Only Tables: Almost No Conflicts</a></li><li><a href=#cdc-tables-position-deletes-are-the-problem>CDC Tables: Position Deletes Are the Problem</a></li><li><a href=#why-equality-deletes-cause-fewer-conflicts>Why Equality Deletes Cause Fewer Conflicts</a></li></ul></li><li><a href=#the-commit-interval-dilemma>The Commit Interval Dilemma</a></li><li><a href=#v2-fix-attempts--all-failed>v2 Fix Attempts — All Failed</a></li><li><a href=#iceberg-v3-how-deletion-vectors-change-the-picture>Iceberg v3: How Deletion Vectors Change the Picture</a><ul><li><a href=#position-delete-files-are-gone>Position Delete Files Are Gone</a></li><li><a href=#why-this-reduces-compaction-conflicts>Why This Reduces Compaction Conflicts</a></li><li><a href=#row-lineage-and-row-level-conflict-detection>Row Lineage and Row-Level Conflict Detection</a></li><li><a href=#not-a-silver-bullet>Not a Silver Bullet</a></li><li><a href=#engine-support-as-of-2025>Engine Support (as of 2025)</a></li></ul></li><li><a href=#the-v2-workaround-pause-cdc-during-compaction>The v2 Workaround: Pause CDC During Compaction</a><ul><li><a href=#things-to-watch>Things to Watch</a></li></ul></li><li><a href=#operational-checklist>Operational Checklist</a></li><li><a href=#wrapping-up>Wrapping Up</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg -ms-5 ps-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#iceberg-v2-row-level-deletes>Iceberg v2 Row-Level Deletes</a><ul><li><a href=#two-ways-to-delete-data-cow-vs-mor>Two Ways to Delete Data: COW vs MOR</a></li><li><a href=#two-kinds-of-delete-files>Two Kinds of Delete Files</a></li><li><a href=#engine-support-varies>Engine Support Varies</a></li></ul></li><li><a href=#the-delta-writer-where-delete-strategy-splits>The Delta Writer: Where Delete Strategy Splits</a></li><li><a href=#snapshot-types-and-commit-conflicts>Snapshot Types and Commit Conflicts</a><ul><li><a href=#four-snapshot-operations>Four Snapshot Operations</a></li><li><a href=#optimistic-concurrency>Optimistic Concurrency</a></li></ul></li><li><a href=#append-only-vs-cdc-why-the-difference>Append-Only vs CDC: Why the Difference</a><ul><li><a href=#append-only-tables-almost-no-conflicts>Append-Only Tables: Almost No Conflicts</a></li><li><a href=#cdc-tables-position-deletes-are-the-problem>CDC Tables: Position Deletes Are the Problem</a></li><li><a href=#why-equality-deletes-cause-fewer-conflicts>Why Equality Deletes Cause Fewer Conflicts</a></li></ul></li><li><a href=#the-commit-interval-dilemma>The Commit Interval Dilemma</a></li><li><a href=#v2-fix-attempts--all-failed>v2 Fix Attempts — All Failed</a></li><li><a href=#iceberg-v3-how-deletion-vectors-change-the-picture>Iceberg v3: How Deletion Vectors Change the Picture</a><ul><li><a href=#position-delete-files-are-gone>Position Delete Files Are Gone</a></li><li><a href=#why-this-reduces-compaction-conflicts>Why This Reduces Compaction Conflicts</a></li><li><a href=#row-lineage-and-row-level-conflict-detection>Row Lineage and Row-Level Conflict Detection</a></li><li><a href=#not-a-silver-bullet>Not a Silver Bullet</a></li><li><a href=#engine-support-as-of-2025>Engine Support (as of 2025)</a></li></ul></li><li><a href=#the-v2-workaround-pause-cdc-during-compaction>The v2 Workaround: Pause CDC During Compaction</a><ul><li><a href=#things-to-watch>Things to Watch</a></li></ul></li><li><a href=#operational-checklist>Operational Checklist</a></li><li><a href=#wrapping-up>Wrapping Up</a></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><p>Run compaction on an Iceberg CDC table and you&rsquo;ll eventually see this:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>org.apache.iceberg.exceptions.ValidationException:
</span></span><span class=line><span class=cl>Cannot commit, found new position delete for replaced data file</span></span></code></pre></div></div><p>Append-only tables don&rsquo;t have this problem. CDC tables do. Understanding why requires digging into how Iceberg v2 handles deletes.</p><hr><h2 class="relative group">Iceberg v2 Row-Level Deletes<div id=iceberg-v2-row-level-deletes class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#iceberg-v2-row-level-deletes aria-label=Anchor>#</a></span></h2><h3 class="relative group">Two Ways to Delete Data: COW vs MOR<div id=two-ways-to-delete-data-cow-vs-mor class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#two-ways-to-delete-data-cow-vs-mor aria-label=Anchor>#</a></span></h3><p>Iceberg offers two strategies for row-level changes.</p><p><strong>Copy-on-Write (COW)</strong>: Rewrite the entire data file with the deleted rows removed. Great read performance, expensive writes. Good for batch updates on read-heavy tables.</p><p><strong>Merge-on-Read (MOR)</strong>: Leave data files untouched. Record deletions in separate <strong>delete files</strong>. Fast writes, but reads pay the cost of merging originals with deletes at query time. This is what CDC/upsert tables use.</p><p>CDC pipelines have constant updates flowing in, so MOR is the natural fit. The catch: the delete files MOR produces are exactly what breaks compaction.</p><h3 class="relative group">Two Kinds of Delete Files<div id=two-kinds-of-delete-files class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#two-kinds-of-delete-files aria-label=Anchor>#</a></span></h3><p>MOR uses two types of delete files.</p><p><strong>Equality delete</strong>: Records the key values of rows to delete. &ldquo;Delete any row with this PK.&rdquo; Can span multiple data files with a single delete file. Downside: readers must do key matching, which costs more at query time.</p><p><strong>Position delete</strong>: Records a specific file path and row number. &ldquo;Delete row 42 in A.parquet.&rdquo; Readers just skip that exact position — faster than key matching.</p><table><thead><tr><th>Type</th><th>What It Records</th><th>Read Cost</th><th>Best For</th></tr></thead><tbody><tr><td>Equality delete</td><td>Key values</td><td>Higher (key matching)</td><td>PK-based bulk deletes</td></tr><tr><td>Position delete</td><td>File path + row number</td><td>Lower (position skip)</td><td>Frequent in-stream updates</td></tr></tbody></table><h3 class="relative group">Engine Support Varies<div id=engine-support-varies class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#engine-support-varies aria-label=Anchor>#</a></span></h3><p>The Iceberg spec defines both types, but not every engine implements everything.</p><table><thead><tr><th>Engine</th><th>Read Eq Delete</th><th>Read Pos Delete</th><th>Write Eq Delete</th><th>Write Pos Delete</th></tr></thead><tbody><tr><td>Spark</td><td>Yes</td><td>Yes</td><td>No</td><td>Yes</td></tr><tr><td>Flink</td><td>Yes</td><td>Yes</td><td>Yes (UPSERT mode)</td><td>Situational</td></tr><tr><td>Trino</td><td>Yes</td><td>Yes</td><td>No</td><td>Yes</td></tr><tr><td>Athena</td><td>Yes</td><td>Yes</td><td>No</td><td>Yes</td></tr><tr><td>Hive/Impala</td><td>Yes</td><td>Yes</td><td>No</td><td>Yes</td></tr></tbody></table><p>Spark can read equality deletes but can&rsquo;t write them. Same for Trino and Athena — they only produce position deletes. Flink is the exception with equality delete writes in UPSERT mode.</p><p>This matters for compaction strategy.</p><hr><h2 class="relative group">The Delta Writer: Where Delete Strategy Splits<div id=the-delta-writer-where-delete-strategy-splits class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#the-delta-writer-where-delete-strategy-splits aria-label=Anchor>#</a></span></h2><p>The CDC sink uses iceberg-core&rsquo;s <code>BaseTaskWriter</code> to process records. The delete logic is interesting:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>deleteKey</span><span class=p>(</span><span class=n>T</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>internalPosDelete</span><span class=p>(</span><span class=n>asStructLikeKey</span><span class=p>(</span><span class=n>key</span><span class=p>)))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>eqDeleteWriter</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>When building a single commit, the writer checks whether the record being deleted exists <strong>in the current stream (commit)</strong>:</p><ul><li><strong>Record is in this stream</strong> → position delete</li><li><strong>Record is not in this stream</strong> → equality delete</li></ul><p>Why not use equality delete for everything? Simpler logic, right? The reason is read performance. Position deletes are cheaper to apply during MOR reads. The write path optimizes for future read performance by preferring position deletes whenever possible.</p><p>This design choice is what causes compaction headaches.</p><hr><h2 class="relative group">Snapshot Types and Commit Conflicts<div id=snapshot-types-and-commit-conflicts class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#snapshot-types-and-commit-conflicts aria-label=Anchor>#</a></span></h2><h3 class="relative group">Four Snapshot Operations<div id=four-snapshot-operations class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#four-snapshot-operations aria-label=Anchor>#</a></span></h3><p>Every Iceberg snapshot has an operation field describing what kind of change happened.</p><table><thead><tr><th>Operation</th><th>Meaning</th><th>Typical Use</th></tr></thead><tbody><tr><td><code>append</code></td><td>Add data files</td><td>Batch loads, INSERT</td></tr><tr><td><code>replace</code></td><td>Swap data/delete files</td><td><strong>Compaction</strong></td></tr><tr><td><code>overwrite</code></td><td>Logical overwrite</td><td><strong>Upsert</strong>, UPDATE, DELETE</td></tr><tr><td><code>delete</code></td><td>Remove data files or add delete files</td><td>DROP PARTITION, etc.</td></tr></tbody></table><p>Compaction is <code>replace</code>. It merges small files into larger ones and swaps them in. CDC sink is <code>overwrite</code>. It produces delete files as part of the upsert process.</p><h3 class="relative group">Optimistic Concurrency<div id=optimistic-concurrency class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#optimistic-concurrency aria-label=Anchor>#</a></span></h3><p>Iceberg handles concurrent writes with optimistic concurrency. Think of it like Git.</p><ol><li>Build a new metadata tree based on the current snapshot</li><li>Attempt an atomic commit (swap)</li><li>If another commit landed in between, run <strong>validation</strong></li><li>Validation passes → commit succeeds. Fails → retry</li></ol><p>The validation rules in step 3 determine which snapshot type combinations conflict and which auto-merge.</p><hr><h2 class="relative group">Append-Only vs CDC: Why the Difference<div id=append-only-vs-cdc-why-the-difference class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#append-only-vs-cdc-why-the-difference aria-label=Anchor>#</a></span></h2><h3 class="relative group">Append-Only Tables: Almost No Conflicts<div id=append-only-tables-almost-no-conflicts class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#append-only-tables-almost-no-conflicts aria-label=Anchor>#</a></span></h3><p>Append-only tables just add data. No delete files. When compaction (<code>replace</code>) runs alongside new inserts (<code>append</code>), they touch different files. Auto-merge works fine. Like merging two Git branches that edited different files — no conflicts.</p><h3 class="relative group">CDC Tables: Position Deletes Are the Problem<div id=cdc-tables-position-deletes-are-the-problem class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#cdc-tables-position-deletes-are-the-problem aria-label=Anchor>#</a></span></h3><p>CDC tables are different. Upserts produce delete files. Here&rsquo;s what goes wrong:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Timeline:
</span></span><span class=line><span class=cl>1. Compaction starts: reads file A, building replacement file B
</span></span><span class=line><span class=cl>2. CDC sink: deletes row 42 in file A (creates position delete)
</span></span><span class=line><span class=cl>3. Compaction finishes: tries to commit A → B replacement
</span></span><span class=line><span class=cl>4. Validation fails: &#34;file A has a new position delete,
</span></span><span class=line><span class=cl>   replacing it would lose that delete&#34;</span></span></code></pre></div></div><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>ValidationException: Cannot commit, found new position delete
</span></span><span class=line><span class=cl>for replaced data file</span></span></code></pre></div></div><p>Compaction already read file A and built a replacement. But a new position delete targeting file A appeared in between. Committing the replacement without that delete would break data correctness. Iceberg rejects the commit.</p><h3 class="relative group">Why Equality Deletes Cause Fewer Conflicts<div id=why-equality-deletes-cause-fewer-conflicts class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#why-equality-deletes-cause-fewer-conflicts aria-label=Anchor>#</a></span></h3><p>Equality deletes say &ldquo;delete rows with this key&rdquo; — a logical declaration not bound to any specific file. When compaction replaces files, key-based deletes still apply to the new files.</p><p>Iceberg has a mechanism for this: compaction preserves the starting <code>sequence-number</code> (<a href=https://github.com/apache/iceberg/pull/3480 target=_blank rel=noreferrer>PR #3480</a>), which lets equality deletes pass validation automatically. This is enabled by default.</p><p>Position deletes point to a specific file at a specific row. Replace that file and the position becomes meaningless. No automatic workaround possible.</p><hr><h2 class="relative group">The Commit Interval Dilemma<div id=the-commit-interval-dilemma class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#the-commit-interval-dilemma aria-label=Anchor>#</a></span></h2><p>&ldquo;Can&rsquo;t we just tune the sink commit interval?&rdquo; You can try. It doesn&rsquo;t solve the problem.</p><p><strong>Longer intervals</strong>: More records per commit. Higher chance that the same record gets inserted then updated or deleted within one stream. The delta writer handles these as position deletes. More position deletes = more conflict potential.</p><p><strong>Shorter intervals</strong>: Fewer position deletes per commit, but commits happen more often. If compaction can&rsquo;t finish before the next commit lands — and it only takes one position delete — conflict.</p><p>Neither direction gets you to zero conflicts.</p><hr><h2 class="relative group">v2 Fix Attempts — All Failed<div id=v2-fix-attempts--all-failed class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#v2-fix-attempts--all-failed aria-label=Anchor>#</a></span></h2><p>Several PRs tried to solve this within the v2 framework. <strong>None were merged.</strong></p><table><thead><tr><th>PR</th><th>Approach</th><th>Outcome</th></tr></thead><tbody><tr><td><a href=https://github.com/apache/iceberg/pull/4703 target=_blank rel=noreferrer>#4703</a></td><td>Skip position delete validation during compaction</td><td>Reviewers deemed it &ldquo;dangerous,&rdquo; closed</td></tr><tr><td><a href=https://github.com/apache/iceberg/pull/4748 target=_blank rel=noreferrer>#4748</a></td><td>Exploit same sequence number between Flink upsert pos-deletes and their data files</td><td>Closed</td></tr><tr><td><a href=https://github.com/apache/iceberg/pull/5760 target=_blank rel=noreferrer>#5760</a></td><td>Add <code>min-data-sequence-number</code> to manifest entries for safer filtering</td><td>Closed by stale bot</td></tr><tr><td><a href=https://github.com/apache/iceberg/pull/7249 target=_blank rel=noreferrer>#7249</a></td><td><code>position-deletes-within-commit-only</code> snapshot property</td><td>Closed by stale bot</td></tr></tbody></table><p>No clean solution emerged within v2. The community converged on <strong>fixing this structurally in v3.</strong></p><hr><h2 class="relative group">Iceberg v3: How Deletion Vectors Change the Picture<div id=iceberg-v3-how-deletion-vectors-change-the-picture class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#iceberg-v3-how-deletion-vectors-change-the-picture aria-label=Anchor>#</a></span></h2><p>The v3 spec was ratified in early 2025. Implementation started shipping with Iceberg 1.8.0 (February 2025). The key change: <strong>Deletion Vectors (DVs).</strong></p><h3 class="relative group">Position Delete Files Are Gone<div id=position-delete-files-are-gone class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#position-delete-files-are-gone aria-label=Anchor>#</a></span></h3><p>v3 bans new position delete file creation outright. DVs take their place.</p><blockquote><p>Position delete files must not be added to v3 tables, but existing position delete files are valid.</p></blockquote><p>A DV is a <strong>Roaring bitmap</strong> stored in a Puffin file. Each bit marks whether a row in a specific data file has been deleted.</p><table><thead><tr><th></th><th>v2 Position Delete</th><th>v3 Deletion Vector</th></tr></thead><tbody><tr><td>Format</td><td>Parquet (file path + row number columns)</td><td>Puffin (Roaring bitmap)</td></tr><tr><td>Per data file</td><td>Unbounded (N files can accumulate)</td><td><strong>At most 1</strong></td></tr><tr><td>On new delete</td><td>Append a separate delete file</td><td>Read existing DV, <strong>merge, replace</strong></td></tr></tbody></table><h3 class="relative group">Why This Reduces Compaction Conflicts<div id=why-this-reduces-compaction-conflicts class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#why-this-reduces-compaction-conflicts aria-label=Anchor>#</a></span></h3><p>The v2 conflict happens because position delete files exist independently of the data files they reference. Compaction replaces a data file, and any position delete file pointing at the old file becomes a dangling reference.</p><p>DVs work differently.</p><p><strong>Tightly coupled to data files.</strong> A DV is a sidecar to its data file. When compaction rewrites a data file, the DV&rsquo;s deletions get absorbed into the new file. The old DV is removed alongside the old data file. No dangling references.</p><p><strong>No independent accumulation.</strong> One data file gets at most one DV. New deletions merge into the existing DV rather than creating a separate file. The &ldquo;new position delete for replaced data file&rdquo; scenario from v2 doesn&rsquo;t arise the same way.</p><p><strong>Less compaction needed.</strong> DVs are compact bitmaps, not Parquet files. They don&rsquo;t create the small-file problem that v2 position delete files did. Fewer compaction runs means a smaller window for conflicts.</p><h3 class="relative group">Row Lineage and Row-Level Conflict Detection<div id=row-lineage-and-row-level-conflict-detection class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#row-lineage-and-row-level-conflict-detection aria-label=Anchor>#</a></span></h3><p>v3 also introduces <strong>Row Lineage</strong>. Every row gets a unique <code>_row_id</code> and <code>_last_updated_sequence_number</code>. Combined with DVs, this enables <strong>row-level conflict detection</strong> (<a href=https://github.com/apache/iceberg/issues/14613 target=_blank rel=noreferrer>Issue #14613</a>).</p><p>In v2, touching the same data file meant a conflict. Period. In v3, two writers modifying different rows in the same file can auto-merge. If the CDC sink deletes row 42 while compaction reorganizes other rows, the commit can succeed without conflict.</p><h3 class="relative group">Not a Silver Bullet<div id=not-a-silver-bullet class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#not-a-silver-bullet aria-label=Anchor>#</a></span></h3><p>OCC still applies. Two writers updating the same data file&rsquo;s DV at the same time will still conflict — one has to retry. But the retry is cheap: just re-merge a bitmap. No data re-scan needed. And once engines implement row-level concurrency using Row Lineage, even same-file conflicts can resolve automatically when different rows are affected.</p><h3 class="relative group">Engine Support (as of 2025)<div id=engine-support-as-of-2025 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#engine-support-as-of-2025 aria-label=Anchor>#</a></span></h3><table><thead><tr><th>Engine</th><th>v3 DV Support</th></tr></thead><tbody><tr><td>Spark (Iceberg 1.8.0+)</td><td>Supported</td></tr><tr><td>AWS EMR / Athena / Glue</td><td>Announced November 2025</td></tr><tr><td>Databricks</td><td>Supported (with row-level concurrency)</td></tr><tr><td>Trino (Starburst)</td><td>In progress</td></tr><tr><td>Flink</td><td>In progress</td></tr></tbody></table><p>Migrating is straightforward: <code>ALTER TABLE ... SET TBLPROPERTIES ('format-version' = '3')</code>. Existing position delete files stay valid. New deletes start using DVs.</p><hr><h2 class="relative group">The v2 Workaround: Pause CDC During Compaction<div id=the-v2-workaround-pause-cdc-during-compaction class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#the-v2-workaround-pause-cdc-during-compaction aria-label=Anchor>#</a></span></h2><p>If you&rsquo;re still on v2, the most reliable approach in production is straightforward: <strong>stop the CDC sink while compaction runs.</strong></p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Compaction pipeline:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>1. Pause CDC sink connector during low-traffic hours (e.g., early morning)
</span></span><span class=line><span class=cl>2. Run compaction (rewrite_data_files)
</span></span><span class=line><span class=cl>3. Resume CDC sink after compaction completes</span></span></code></pre></div></div><p>Kakao&rsquo;s tech blog describes a similar approach — pausing real-time CDC ingestion at roughly 12-hour intervals for table maintenance.</p><h3 class="relative group">Things to Watch<div id=things-to-watch class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#things-to-watch aria-label=Anchor>#</a></span></h3><ul><li><strong>Compaction can take longer than expected.</strong> A full day&rsquo;s worth of CDC data might take hours to compact. Measure your window empirically.</li><li><strong>Consider partition-level compaction.</strong> Don&rsquo;t compact the entire table at once. Splitting by partition cuts wall time.</li><li><strong>Clean up delete files separately.</strong> Run <code>rewrite_position_delete_files</code> periodically for minor compaction. Watch for version-specific bugs — they&rsquo;ve been reported.</li></ul><hr><h2 class="relative group">Operational Checklist<div id=operational-checklist class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#operational-checklist aria-label=Anchor>#</a></span></h2><ol><li><strong>Check your runtime version</strong>: Verify <code>rewrite_data_files</code> validation rules and <code>rewrite_position_delete_files</code> support in your EMR/Spark/Flink/Trino version</li><li><strong>Monitor conflict rates</strong>: Measure CDC commit frequency vs compaction duration. Track how often conflicts actually occur</li><li><strong>Build a metadata dashboard</strong>: Visualize file counts, average sizes, and delete file accumulation from snapshot/manifest tables</li><li><strong>Secure a compaction window</strong>: Set up nightly CDC pause or partition-level compaction schedules</li><li><strong>Evaluate v3 migration</strong>: If your engine supports v3 DVs, migration eliminates most of the operational overhead described above</li></ol><hr><h2 class="relative group">Wrapping Up<div id=wrapping-up class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#wrapping-up aria-label=Anchor>#</a></span></h2><p>Here&rsquo;s the short version:</p><ul><li>Iceberg v2&rsquo;s MOR path uses <strong>position deletes to optimize read performance</strong></li><li>Position deletes are bound to specific files, so they <strong>conflict with compaction (replace)</strong></li><li>Equality deletes get auto-resolved via the <code>sequence-number</code> mechanism. Position deletes don&rsquo;t</li><li>Every attempt to fix this within v2 was closed without merging</li><li><strong>v3 Deletion Vectors are the structural fix.</strong> One bitmap per data file instead of unbounded position delete files. Row Lineage enables row-level conflict detection on top of that</li><li>On v2, <strong>the pragmatic answer is pausing CDC during a compaction window</strong></li></ul><p>The v3 spec is ratified and engine support is expanding fast. If you&rsquo;re still on v2, planning the migration to v3 is the long-term play. Most of the operational overhead described in this post goes away once DVs are in place.</p><p><strong>References:</strong></p><ul><li><a href=https://www.dremio.com/blog/row-level-changes-on-the-lakehouse-copy-on-write-vs-merge-on-read-in-apache-iceberg/ target=_blank rel=noreferrer>Row-Level Changes on the Lakehouse: COW vs MOR in Apache Iceberg (Dremio)</a></li><li><a href=https://iceberg.apache.org/spec/#row-level-deletes target=_blank rel=noreferrer>Apache Iceberg Spec - Row-level Deletes</a></li><li><a href=https://iceberg.apache.org/docs/latest/reliability/ target=_blank rel=noreferrer>Apache Iceberg - Reliability (Concurrency)</a></li><li><a href=https://github.com/apache/iceberg/pull/3480 target=_blank rel=noreferrer>PR #3480: Core: support rewrite data files with starting sequence number</a></li><li><a href=https://github.com/apache/iceberg/pull/4703 target=_blank rel=noreferrer>PR #4703: API: Optionally ignore position deletes in rewrite validation</a></li><li><a href=https://github.com/apache/iceberg/pull/7249 target=_blank rel=noreferrer>PR #7249: Avoid conflicts between rewrite datafiles and flink CDC writes</a></li><li><a href=https://tech.kakao.com/posts/656 target=_blank rel=noreferrer>Iceberg Table Loading and Operation Strategy by Log Type (Kakao Tech)</a></li><li><a href=https://github.com/apache/iceberg/issues/11122 target=_blank rel=noreferrer>Improve Position Deletes in V3 (Issue #11122)</a></li><li><a href=https://github.com/apache/iceberg/issues/11129 target=_blank rel=noreferrer>Row Lineage for V3 (Issue #11129)</a></li><li><a href=https://github.com/apache/iceberg/issues/14613 target=_blank rel=noreferrer>Row-level concurrency (Issue #14613)</a></li><li><a href=https://opensource.googleblog.com/2025/08/whats-new-in-iceberg-v3.html target=_blank rel=noreferrer>What&rsquo;s New in Apache Iceberg v3 (Google Open Source Blog)</a></li><li><a href=https://aws.amazon.com/blogs/big-data/unlock-the-power-of-apache-iceberg-v3-deletion-vectors-on-amazon-emr/ target=_blank rel=noreferrer>Iceberg V3 Deletion Vectors on Amazon EMR (AWS Blog)</a></li></ul></div><section class="flex flex-row flex-wrap justify-center pt-4 text-xl"><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://nanta-data.dev/posts/iceberg-cdc-compaction-challenge/&amp;title=Iceberg%20-%20Why%20CDC%20Table%20Compaction%20Is%20So%20Tricky" title="Share on LinkedIn" aria-label="Share on LinkedIn"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://reddit.com/submit/?url=https://nanta-data.dev/posts/iceberg-cdc-compaction-challenge/&amp;resubmit=true&amp;title=Iceberg%20-%20Why%20CDC%20Table%20Compaction%20Is%20So%20Tricky" title="Submit to Reddit" aria-label="Submit to Reddit"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M201.5 305.5c-13.8.0-24.9-11.1-24.9-24.6.0-13.8 11.1-24.9 24.9-24.9 13.6.0 24.6 11.1 24.6 24.9.0 13.6-11.1 24.6-24.6 24.6zM504 256c0 137-111 248-248 248S8 393 8 256 119 8 256 8s248 111 248 248zm-132.3-41.2c-9.4.0-17.7 3.9-23.8 10-22.4-15.5-52.6-25.5-86.1-26.6l17.4-78.3 55.4 12.5c0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.3 24.9-24.9s-11.1-24.9-24.9-24.9c-9.7.0-18 5.8-22.1 13.8l-61.2-13.6c-3-.8-6.1 1.4-6.9 4.4l-19.1 86.4c-33.2 1.4-63.1 11.3-85.5 26.8-6.1-6.4-14.7-10.2-24.1-10.2-34.9.0-46.3 46.9-14.4 62.8-1.1 5-1.7 10.2-1.7 15.5.0 52.6 59.2 95.2 132 95.2 73.1.0 132.3-42.6 132.3-95.2.0-5.3-.6-10.8-1.9-15.8 31.3-16 19.8-62.5-14.9-62.5zM302.8 331c-18.2 18.2-76.1 17.9-93.6.0-2.2-2.2-6.1-2.2-8.3.0-2.5 2.5-2.5 6.4.0 8.6 22.8 22.8 87.3 22.8 110.2.0 2.5-2.2 2.5-6.1.0-8.6-2.2-2.2-6.1-2.2-8.3.0zm7.7-75c-13.6.0-24.6 11.1-24.6 24.9.0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.1 24.9-24.6.0-13.8-11-24.9-24.9-24.9z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="mailto:?body=https://nanta-data.dev/posts/iceberg-cdc-compaction-challenge/&amp;subject=Iceberg%20-%20Why%20CDC%20Table%20Compaction%20Is%20So%20Tricky" title="Send via email" aria-label="Send via email"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></a></section></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span class="flex flex-col"><a class="flex text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" href=/posts/2026-data-engineering-trends/><span class=leading-6><span class="inline-block rtl:rotate-180">&larr;</span>&ensp;2026 Data Engineering Trends and Where Large-Scale Platforms Stand
</span></a><span class="ms-6 mt-1 text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2026-02-23T00:00:00+00:00>23 February 2026</time>
</span></span><span class="flex flex-col items-end"><a class="flex text-right text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" href=/posts/apisix-proxy-server-guide/><span class=leading-6>Building a Proxy Server with Apache APISIX: De-identifying 1.3 Billion Daily Logs&ensp;<span class="inline-block rtl:rotate-180">&rarr;</span>
</span></a><span class="me-6 mt-1 text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2026-02-24T00:00:00+00:00>24 February 2026</time></span></span></div></div></footer></article><div id=scroll-to-top class="fixed bottom-6 end-6 z-50 transform translate-y-4 opacity-0 duration-200"><a href=#the-top class="pointer-events-auto flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex list-none flex-col sm:flex-row"><li class="flex mb-1 text-end sm:mb-0 sm:me-7 sm:last:me-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href=/privacy-policy/ title="Privacy Policy">Privacy Policy</a></li></ul></nav><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2026
nanta</p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500" data-url=https://nanta-data.dev/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>