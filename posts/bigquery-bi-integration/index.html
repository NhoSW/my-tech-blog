<!doctype html><html lang=ko dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="ko"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>Superset에서 BigQuery가 무한 블로킹되는 이유: gevent와 gRPC의 호환성 문제 &#183; nanta - 데이터 엔지니어링</title><meta name=title content="Superset에서 BigQuery가 무한 블로킹되는 이유: gevent와 gRPC의 호환성 문제 &#183; nanta - 데이터 엔지니어링"><meta name=description content="사용자 권한별로 BigQuery를 BI에서 사용할 수 있도록 Redash와 Superset에 연동했다. Redash는 스키마 조회 불가라는 알려진 한계가 있었고, Superset은 더 심각한 문제를 만났다. SqlLab에서는 정상인데 차트 화면에서 쿼리가 무한 블로킹됐다. 원인은 gunicorn의 gevent 워커가 Python 코어 라이브러리를 멍키패칭하면서 BigQuery SDK의 gRPC 호출을 교착시키는 문제였다. 워커 타입을 gthread로 교체해서 해결했고, 업스트림에 문서 픽스 PR을 기여했다."><meta name=keywords content="superset,bigquery,redash,gunicorn,gevent,grpc,troubleshooting,"><link rel=canonical href=https://nanta-data.dev/posts/bigquery-bi-integration/><meta name=author content="nanta"><link href=https://github.com/NhoSW rel=me><meta property="og:url" content="https://nanta-data.dev/posts/bigquery-bi-integration/"><meta property="og:site_name" content="nanta - 데이터 엔지니어링"><meta property="og:title" content="Superset에서 BigQuery가 무한 블로킹되는 이유: gevent와 gRPC의 호환성 문제"><meta property="og:description" content="사용자 권한별로 BigQuery를 BI에서 사용할 수 있도록 Redash와 Superset에 연동했다. Redash는 스키마 조회 불가라는 알려진 한계가 있었고, Superset은 더 심각한 문제를 만났다. SqlLab에서는 정상인데 차트 화면에서 쿼리가 무한 블로킹됐다. 원인은 gunicorn의 gevent 워커가 Python 코어 라이브러리를 멍키패칭하면서 BigQuery SDK의 gRPC 호출을 교착시키는 문제였다. 워커 타입을 gthread로 교체해서 해결했고, 업스트림에 문서 픽스 PR을 기여했다."><meta property="og:locale" content="ko"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2026-02-27T00:00:00+00:00"><meta property="article:modified_time" content="2026-02-27T00:00:00+00:00"><meta property="article:tag" content="Superset"><meta property="article:tag" content="Bigquery"><meta property="article:tag" content="Redash"><meta property="article:tag" content="Gunicorn"><meta property="article:tag" content="Gevent"><meta property="article:tag" content="Grpc"><meta name=twitter:card content="summary"><meta name=twitter:title content="Superset에서 BigQuery가 무한 블로킹되는 이유: gevent와 gRPC의 호환성 문제"><meta name=twitter:description content="사용자 권한별로 BigQuery를 BI에서 사용할 수 있도록 Redash와 Superset에 연동했다. Redash는 스키마 조회 불가라는 알려진 한계가 있었고, Superset은 더 심각한 문제를 만났다. SqlLab에서는 정상인데 차트 화면에서 쿼리가 무한 블로킹됐다. 원인은 gunicorn의 gevent 워커가 Python 코어 라이브러리를 멍키패칭하면서 BigQuery SDK의 gRPC 호출을 교착시키는 문제였다. 워커 타입을 gthread로 교체해서 해결했고, 업스트림에 문서 픽스 PR을 기여했다."><link type=text/css rel=stylesheet href=/css/main.bundle.min.c14e86e0d9a09802d254d2a15c05847ae65bfc2e98c2166fabc67369d2d7f2eae6c1da03bbba58cfd41a4af802147c75ce9fdc11dd724ac627ab2903942cbb79.css integrity="sha512-wU6G4NmgmALSVNKhXAWEeuZb/C6YwhZvq8ZzadLX8urmwdoDu7pYz9QaSvgCFHx1zp/cEd1ySsYnqykDlCy7eQ=="><script type=text/javascript src=/js/appearance.min.6f41174b3a05b680820fe08cadbfa5fb7a7ca347b76a0955cdc68b9d8aca1ce24f0547e138cea33bcc7904d551a90afcb1cc7f2d9fe8557075d501419046c08c.js integrity="sha512-b0EXSzoFtoCCD+CMrb+l+3p8o0e3aglVzcaLnYrKHOJPBUfhOM6jO8x5BNVRqQr8scx/LZ/oVXB11QFBkEbAjA=="></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.bdda7dece6cbaf08deef7d254f7f842f3261c2524d247905127c9a20decc03f1011a2950048464c79272c1ce0705a49a41147f39f2b95163bb71d404b33263ef.js integrity="sha512-vdp97ObLrwje730lT3+ELzJhwlJNJHkFEnyaIN7MA/EBGilQBIRkx5Jywc4HBaSaQRR/OfK5UWO7cdQEszJj7w==" data-copy=복사 data-copied=복사되었습니다></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"글 목록","name":"Superset에서 BigQuery가 무한 블로킹되는 이유: gevent와 gRPC의 호환성 문제","headline":"Superset에서 BigQuery가 무한 블로킹되는 이유: gevent와 gRPC의 호환성 문제","inLanguage":"ko","url":"https://nanta-data.dev/posts/bigquery-bi-integration/","author":{"@type":"Person","name":"nanta"},"copyrightYear":"2026","dateCreated":"2026-02-27T00:00:00\u002b00:00","datePublished":"2026-02-27T00:00:00\u002b00:00","dateModified":"2026-02-27T00:00:00\u002b00:00","keywords":["superset","bigquery","redash","gunicorn","gevent","grpc","troubleshooting"],"mainEntityOfPage":"true","wordCount":"1114"}]</script><link rel=preconnect href=https://cdn.jsdelivr.net crossorigin><link href=https://cdn.jsdelivr.net/npm/geist@1.3.1/dist/fonts/geist-sans/style.min.css rel=stylesheet><link href=https://cdn.jsdelivr.net/npm/geist@1.3.1/dist/fonts/geist-mono/style.min.css rel=stylesheet></head><body class="flex flex-col h-screen m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32 text-lg bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral bf-scrollbar"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 pe-2 dark:text-primary-400">&darr;</span>
본문으로 건너뛰기</a></div><div class=min-h-[148px]></div><div class="fixed inset-x-0 z-100"><div id=menu-blur class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl bg-neutral/25 dark:bg-neutral-800/25"></div><div class="relative m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32"><div class="main-menu flex items-center w-full gap-2 p-1 pl-0"><a href=/ class="text-base font-medium truncate min-w-0 shrink">nanta - 데이터 엔지니어링</a><div class="flex items-center ms-auto"><div class="hidden md:flex"><nav class="flex items-center gap-x-5 h-12"><a href=/posts/ class="flex items-center bf-icon-color-hover" aria-label="글 목록" title="글 목록"><span class="text-base font-medium break-normal">글 목록
</span></a><a href=/categories/ class="flex items-center bf-icon-color-hover" aria-label=카테고리 title=Categories><span class="text-base font-medium break-normal">카테고리
</span></a><a href=/tags/ class="flex items-center bf-icon-color-hover" aria-label=태그 title=Tags><span class="text-base font-medium break-normal">태그
</span></a><a href=/about/ class="flex items-center bf-icon-color-hover" aria-label=소개 title=소개><span class="text-base font-medium break-normal">소개</span></a><div class="translation nested-menu"><button class="cursor-pointer flex items-center">
<span class=me-1><span class="relative block icon"><svg viewBox="0 0 640 512"><path fill="currentColor" d="M0 128C0 92.7 28.7 64 64 64H256h48 16H576c35.3.0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H320 304 256 64c-35.3.0-64-28.7-64-64V128zm320 0V384H576V128H320zM178.3 175.9c-3.2-7.2-10.4-11.9-18.3-11.9s-15.1 4.7-18.3 11.9l-64 144c-4.5 10.1.1 21.9 10.2 26.4s21.9-.1 26.4-10.2l8.9-20.1h73.6l8.9 20.1c4.5 10.1 16.3 14.6 26.4 10.2s14.6-16.3 10.2-26.4l-64-144zM160 233.2 179 276H141l19-42.8zM448 164c11 0 20 9 20 20v4h44 16c11 0 20 9 20 20s-9 20-20 20h-2l-1.6 4.5c-8.9 24.4-22.4 46.6-39.6 65.4.9.6 1.8 1.1 2.7 1.6l18.9 11.3c9.5 5.7 12.5 18 6.9 27.4s-18 12.5-27.4 6.9L467 333.8c-4.5-2.7-8.8-5.5-13.1-8.5-10.6 7.5-21.9 14-34 19.4l-3.6 1.6c-10.1 4.5-21.9-.1-26.4-10.2s.1-21.9 10.2-26.4l3.6-1.6c6.4-2.9 12.6-6.1 18.5-9.8L410 286.1c-7.8-7.8-7.8-20.5.0-28.3s20.5-7.8 28.3.0l14.6 14.6.5.5c12.4-13.1 22.5-28.3 29.8-45H448 376c-11 0-20-9-20-20s9-20 20-20h52v-4c0-11 9-20 20-20z"/></svg></span>
</span><span class="text-sm font-medium bf-icon-color-hover" title="Superset에서 BigQuery가 무한 블로킹되는 이유: gevent와 gRPC의 호환성 문제">KO</span></button><ul class=menuhide><li class="rounded-xl backdrop-blur shadow-2xl p-2 flex flex-col gap-1"><a href=/posts/bigquery-bi-integration/ class="flex items-center bf-icon-color-hover px-3 py-1"><span class="text-sm font-sm" title="Superset에서 BigQuery가 무한 블로킹되는 이유: gevent와 gRPC의 호환성 문제">한국어
</span></a><a href=/en/posts/bigquery-bi-integration/ class="flex items-center bf-icon-color-hover px-3 py-1"><span class="text-sm font-sm" title="Why BigQuery Hangs in Superset: The gevent and gRPC Incompatibility">English</span></a></li></ul></div><button id=search-button aria-label=Search class="text-base bf-icon-color-hover" title="검색하기 (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base bf-icon-color-hover"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav></div><div class="flex md:hidden"><div class="flex items-center h-14 gap-4"><button id=search-button-mobile aria-label=Search class="flex items-center justify-center bf-icon-color-hover" title="검색하기 (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile type=button aria-label="Dark mode switcher" class="flex items-center justify-center text-neutral-900 hover:text-primary-600 dark:text-neutral-200 dark:hover:text-primary-400"><div class=dark:hidden><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="hidden dark:block"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button>
<input type=checkbox id=mobile-menu-toggle autocomplete=off class="hidden peer">
<label for=mobile-menu-toggle class="flex items-center justify-center cursor-pointer bf-icon-color-hover"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></label><div role=dialog aria-modal=true style=scrollbar-gutter:stable class="fixed inset-0 z-50 invisible overflow-y-auto px-6 py-20 opacity-0 transition-[opacity,visibility] duration-300 peer-checked:visible peer-checked:opacity-100 bg-neutral-50/97 dark:bg-neutral-900/99
bf-scrollbar"><label for=mobile-menu-toggle class="fixed end-8 top-5 flex items-center justify-center z-50 h-12 w-12 cursor-pointer select-none rounded-full bf-icon-color-hover border bf-border-color bf-border-color-hover bg-neutral-50 dark:bg-neutral-900"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></label><nav class="mx-auto max-w-md space-y-6"><div class=px-2><a href=/posts/ aria-label="글 목록" class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title="글 목록" class="text-2xl font-bold tracking-tight">글 목록</span></a></div><div class=px-2><a href=/categories/ aria-label=카테고리 class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title=Categories class="text-2xl font-bold tracking-tight">카테고리</span></a></div><div class=px-2><a href=/tags/ aria-label=태그 class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title=Tags class="text-2xl font-bold tracking-tight">태그</span></a></div><div class=px-2><a href=/about/ aria-label=소개 class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title=소개 class="text-2xl font-bold tracking-tight">소개</span></a></div><div class="flex flex-wrap items-center [&_span]:text-2xl [&_.translation_button_.icon]:text-4xl! [&_.translation_button_span]:text-base! [&_.translation_.menuhide_span]:text-sm! gap-x-6 ps-2 mt-8 pt-8 border-t bf-border-color"><div class="translation nested-menu"><button class="cursor-pointer flex items-center">
<span class=me-1><span class="relative block icon"><svg viewBox="0 0 640 512"><path fill="currentColor" d="M0 128C0 92.7 28.7 64 64 64H256h48 16H576c35.3.0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H320 304 256 64c-35.3.0-64-28.7-64-64V128zm320 0V384H576V128H320zM178.3 175.9c-3.2-7.2-10.4-11.9-18.3-11.9s-15.1 4.7-18.3 11.9l-64 144c-4.5 10.1.1 21.9 10.2 26.4s21.9-.1 26.4-10.2l8.9-20.1h73.6l8.9 20.1c4.5 10.1 16.3 14.6 26.4 10.2s14.6-16.3 10.2-26.4l-64-144zM160 233.2 179 276H141l19-42.8zM448 164c11 0 20 9 20 20v4h44 16c11 0 20 9 20 20s-9 20-20 20h-2l-1.6 4.5c-8.9 24.4-22.4 46.6-39.6 65.4.9.6 1.8 1.1 2.7 1.6l18.9 11.3c9.5 5.7 12.5 18 6.9 27.4s-18 12.5-27.4 6.9L467 333.8c-4.5-2.7-8.8-5.5-13.1-8.5-10.6 7.5-21.9 14-34 19.4l-3.6 1.6c-10.1 4.5-21.9-.1-26.4-10.2s.1-21.9 10.2-26.4l3.6-1.6c6.4-2.9 12.6-6.1 18.5-9.8L410 286.1c-7.8-7.8-7.8-20.5.0-28.3s20.5-7.8 28.3.0l14.6 14.6.5.5c12.4-13.1 22.5-28.3 29.8-45H448 376c-11 0-20-9-20-20s9-20 20-20h52v-4c0-11 9-20 20-20z"/></svg></span>
</span><span class="text-sm font-medium bf-icon-color-hover" title="Superset에서 BigQuery가 무한 블로킹되는 이유: gevent와 gRPC의 호환성 문제">KO</span></button><ul class=menuhide><li class="rounded-xl backdrop-blur shadow-2xl p-2 flex flex-col gap-1"><a href=/posts/bigquery-bi-integration/ class="flex items-center bf-icon-color-hover px-3 py-1"><span class="text-sm font-sm" title="Superset에서 BigQuery가 무한 블로킹되는 이유: gevent와 gRPC의 호환성 문제">한국어
</span></a><a href=/en/posts/bigquery-bi-integration/ class="flex items-center bf-icon-color-hover px-3 py-1"><span class="text-sm font-sm" title="Why BigQuery Hangs in Superset: The gevent and gRPC Incompatibility">English</span></a></li></ul></div></div></nav></div></div></div></div></div></div></div><script type=text/javascript src=/js/background-blur.min.605b3b942818f0ab5a717ae446135ec46b8ee5a2ad12ae56fb90dc2a76ce30c388f9fec8bcc18db15bd47e3fa8a09d779fa12aa9c184cf614a315bc72c6c163d.js integrity="sha512-YFs7lCgY8KtacXrkRhNexGuO5aKtEq5W+5DcKnbOMMOI+f7IvMGNsVvUfj+ooJ13n6EqqcGEz2FKMVvHLGwWPQ==" data-blur-id=menu-blur></script><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class=hidden><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/>nanta - 데이터 엔지니어링</a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/>글 목록</a><span class="px-1 text-primary-500">/</span></li><li class=hidden><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/bigquery-bi-integration/>Superset에서 BigQuery가 무한 블로킹되는 이유: gevent와 gRPC의 호환성 문제</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Superset에서 BigQuery가 무한 블로킹되는 이유: gevent와 gRPC의 호환성 문제</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2026-02-27T00:00:00+00:00>2026년 2월 27일</time><span class="px-2 text-primary-500">&#183;</span><span title="읽는 시간">6 분</span></div></div><div class="flex author"><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">작성자</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">nanta</div><div class="text-sm text-neutral-700 dark:text-neutral-400">Apache Kafka, Airflow, Trino, StarRocks 등 데이터 엔지니어링과 모던 데이터 인프라에 대한 실무 경험을 공유하는 블로그입니다.</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/NhoSW target=_blank aria-label=Github title=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span></a></div></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ms-auto px-0 lg:order-last lg:ps-8 lg:max-w-2xs"><div class="toc ps-5 print:hidden lg:sticky lg:top-[140px]"><details open id=TOCView class="toc-right mt-0 overflow-y-auto overscroll-contain bf-scrollbar rounded-lg -ms-5 ps-5 pe-2 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">목차</summary><div class="min-w-[220px] py-2 border-dotted border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#redash-bigquery-연동>Redash BigQuery 연동</a></li><li><a href=#superset-bigquery-연동>Superset BigQuery 연동</a><ul><li><a href=#디펜던시-설치>디펜던시 설치</a></li><li><a href=#쿼리가-블로킹된다>쿼리가 블로킹된다</a></li></ul></li><li><a href=#sqllab은-되고-차트는-안-되는-이유>SqlLab은 되고 차트는 안 되는 이유</a><ul><li><a href=#비동기-모드의-동작-차이>비동기 모드의 동작 차이</a></li><li><a href=#코드-레벨-블로킹-지점>코드 레벨 블로킹 지점</a></li></ul></li><li><a href=#원인-gevent의-멍키패칭이-grpc를-교착시킨다>원인: gevent의 멍키패칭이 gRPC를 교착시킨다</a><ul><li><a href=#gunicorn의-워커-타입>gunicorn의 워커 타입</a></li><li><a href=#멍키패칭과-grpc의-충돌>멍키패칭과 gRPC의 충돌</a></li><li><a href=#왜-celery-워커는-괜찮은가>왜 Celery 워커는 괜찮은가</a></li></ul></li><li><a href=#해결-gevent에서-gthread로>해결: gevent에서 gthread로</a><ul><li><a href=#워커-타입-교체>워커 타입 교체</a></li><li><a href=#동시성-영향>동시성 영향</a></li><li><a href=#업스트림-기여>업스트림 기여</a></li></ul></li><li><a href=#impersonation-관련-참고>Impersonation 관련 참고</a></li><li><a href=#배운-것>배운 것</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg -ms-5 ps-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">목차</summary><div class="py-2 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#redash-bigquery-연동>Redash BigQuery 연동</a></li><li><a href=#superset-bigquery-연동>Superset BigQuery 연동</a><ul><li><a href=#디펜던시-설치>디펜던시 설치</a></li><li><a href=#쿼리가-블로킹된다>쿼리가 블로킹된다</a></li></ul></li><li><a href=#sqllab은-되고-차트는-안-되는-이유>SqlLab은 되고 차트는 안 되는 이유</a><ul><li><a href=#비동기-모드의-동작-차이>비동기 모드의 동작 차이</a></li><li><a href=#코드-레벨-블로킹-지점>코드 레벨 블로킹 지점</a></li></ul></li><li><a href=#원인-gevent의-멍키패칭이-grpc를-교착시킨다>원인: gevent의 멍키패칭이 gRPC를 교착시킨다</a><ul><li><a href=#gunicorn의-워커-타입>gunicorn의 워커 타입</a></li><li><a href=#멍키패칭과-grpc의-충돌>멍키패칭과 gRPC의 충돌</a></li><li><a href=#왜-celery-워커는-괜찮은가>왜 Celery 워커는 괜찮은가</a></li></ul></li><li><a href=#해결-gevent에서-gthread로>해결: gevent에서 gthread로</a><ul><li><a href=#워커-타입-교체>워커 타입 교체</a></li><li><a href=#동시성-영향>동시성 영향</a></li><li><a href=#업스트림-기여>업스트림 기여</a></li></ul></li><li><a href=#impersonation-관련-참고>Impersonation 관련 참고</a></li><li><a href=#배운-것>배운 것</a></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><p>사용자 권한에 따라 BigQuery 데이터를 BI 도구에서 조회할 수 있도록 지원해달라는 요청이 들어왔다. 기존에 운영하고 있는 Redash와 Superset 양쪽에 BigQuery 연동을 진행했다.</p><p>Redash는 비교적 수월했다. 스키마 조회가 안 되는 알려진 한계가 있었지만 쿼리 자체는 동작했다. Superset은 달랐다. 쿼리가 BigQuery에 정상 제출되는데도 결과가 돌아오지 않고 무한 블로킹되는 현상을 만났다. 원인을 추적해보니 Python의 동시성 모델 깊은 곳에서 충돌이 일어나고 있었다.</p><hr><h2 class="relative group">Redash BigQuery 연동<div id=redash-bigquery-연동 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#redash-bigquery-%ec%97%b0%eb%8f%99 aria-label=앵커>#</a></span></h2><p>Redash에서 BigQuery 연동 자체는 간단하다. Data Source에 BigQuery를 추가하고 서비스 계정 JSON 키를 등록하면 된다.</p><p>쿼리 실행은 정상 동작한다. 하지만 하나 문제가 있다. 웹 UI에서 데이터셋과 테이블의 스키마를 조회할 수 없다. 사이드바에 테이블 목록이 나오지 않는다.</p><p>이 이슈는 Redash 커뮤니티의 알려진 문제(known issue)다. BigQuery의 메타데이터 API가 반환하는 구조가 Redash의 스키마 파싱 로직과 맞지 않는 것으로 보이는데, 커뮤니티에서 수년간 보고됐지만 수정되지 않았다. Redash 프로젝트 자체의 활발도가 낮아진 상황이라 앞으로도 수정될 가능성은 높지 않다.</p><p>실제 스키마 확인은 BigQuery 웹 콘솔에서 직접 해야 한다. 쿼리 작성에 불편함이 있지만, Superset에서 BigQuery를 전사 BI로 활용할 계획이었기 때문에 Redash 쪽은 이 상태로 두기로 했다.</p><hr><h2 class="relative group">Superset BigQuery 연동<div id=superset-bigquery-연동 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#superset-bigquery-%ec%97%b0%eb%8f%99 aria-label=앵커>#</a></span></h2><h3 class="relative group">디펜던시 설치<div id=디펜던시-설치 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%eb%94%94%ed%8e%9c%eb%8d%98%ec%8b%9c-%ec%84%a4%ec%b9%98 aria-label=앵커>#</a></span></h3><p>Superset에 BigQuery를 연동하려면 <code>sqlalchemy-bigquery</code>와 <code>pybigquery</code> 디펜던시를 추가해야 한다. 우리는 Superset을 커스텀 Docker 이미지로 운영하고 있어서 이미지 빌드 단계에서 디펜던시를 추가했다.</p><p>BigQuery 관련 패키지가 기존 Superset 디펜던시와 버전 충돌을 일으키는 부분이 있었다. <code>google-cloud-bigquery</code>, <code>google-auth</code>, <code>grpcio</code> 등의 버전을 맞추는 작업이 필요했다. 디펜던시 컨플릭트를 해결하고 이미지를 빌드해서 배포했다.</p><p>Redash와 달리 Superset은 BigQuery 데이터셋과 테이블의 스키마가 웹 UI에 정상적으로 표시됐다. 이것만으로도 Superset을 BigQuery 전용 BI로 활용할 이유가 충분했다.</p><h3 class="relative group">쿼리가 블로킹된다<div id=쿼리가-블로킹된다 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%ec%bf%bc%eb%a6%ac%ea%b0%80-%eb%b8%94%eb%a1%9c%ed%82%b9%eb%90%9c%eb%8b%a4 aria-label=앵커>#</a></span></h3><p>디펜던시 설치와 커넥션 설정을 마치고 테스트를 시작했는데, 이상한 현상이 발생했다.</p><p>SqlLab에서 쿼리를 실행하면 정상적으로 결과가 반환된다. 하지만 차트 개발 화면에서 쿼리를 실행하면 응답이 오지 않는다. 약 60초 후에 Gateway Timeout이 발생한다.</p><p>GCP BigQuery 콘솔에서 확인해보면, 블로킹된 쿼리도 BigQuery 쪽에서는 정상적으로 제출되어 완료됐다. 쿼리는 실행됐는데, 결과가 Superset으로 돌아오지 않는 것이다.</p><p>이 시점에서 Superset GitHub Issues를 검색했다. 동일한 증상을 보고한 이슈가 이미 있었다. 하지만 이슈 스레드에서 소개된 해결 방법들을 시도해봐도 해결되지 않았다.</p><hr><h2 class="relative group">SqlLab은 되고 차트는 안 되는 이유<div id=sqllab은-되고-차트는-안-되는-이유 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#sqllab%ec%9d%80-%eb%90%98%ea%b3%a0-%ec%b0%a8%ed%8a%b8%eb%8a%94-%ec%95%88-%eb%90%98%eb%8a%94-%ec%9d%b4%ec%9c%a0 aria-label=앵커>#</a></span></h2><p>직접 디버깅에 나섰다. SqlLab과 차트 개발 화면 사이에 무엇이 다른지를 추적했다.</p><h3 class="relative group">비동기 모드의 동작 차이<div id=비동기-모드의-동작-차이 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%eb%b9%84%eb%8f%99%ea%b8%b0-%eb%aa%a8%eb%93%9c%ec%9d%98-%eb%8f%99%ec%9e%91-%ec%b0%a8%ec%9d%b4 aria-label=앵커>#</a></span></h3><p>Superset의 비동기 모드(<code>ASYNC_QUERIES_REDIS</code>)를 활성화하면, SqlLab에서 실행된 쿼리는 Celery 워커에 위임된다. Celery 워커는 별도의 프로세스에서 쿼리를 실행하고 결과를 Redis에 저장한다. 웹서버는 결과를 폴링해서 사용자에게 반환할 뿐이다.</p><p>하지만 대시보드와 차트 개발 환경에서는 비동기 모드가 켜져 있어도 쿼리 제출 로직이 웹서버 프로세스(gunicorn)에서 직접 실행된다. 파드 로그를 확인해서 이 차이를 확인했다.</p><p><code>GLOBAL_ASYNC_QUERIES</code> 피처 플래그를 활성화하면 일부 UI에서 추가로 Celery 워커를 사용하지만, 강제 리프레시(캐시 무시) 같은 동작에서는 여전히 웹서버에서 쿼리가 제출된다.</p><p>정리하면:</p><table><thead><tr><th>실행 환경</th><th>쿼리 실행 위치</th><th>결과</th></tr></thead><tbody><tr><td>SqlLab</td><td>Celery 워커</td><td>정상</td></tr><tr><td>차트 개발 화면</td><td>gunicorn 웹서버</td><td>블로킹</td></tr><tr><td>강제 리프레시</td><td>gunicorn 웹서버</td><td>블로킹</td></tr></tbody></table><p><strong>Celery 워커에서 실행되면 정상, gunicorn 웹서버에서 실행되면 블로킹.</strong> 문제는 gunicorn에 있다.</p><h3 class="relative group">코드 레벨 블로킹 지점<div id=코드-레벨-블로킹-지점 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%ec%bd%94%eb%93%9c-%eb%a0%88%eb%b2%a8-%eb%b8%94%eb%a1%9c%ed%82%b9-%ec%a7%80%ec%a0%90 aria-label=앵커>#</a></span></h3><p>코드를 추적해서 블로킹이 발생하는 정확한 지점을 확인했다. Superset의 <code>db_engine_specs/bigquery.py</code>에서 <code>python-bigquery</code> SDK의 메서드를 호출하는 부분이었다. Celery 워커에서는 이 호출이 정상적으로 반환되지만, gunicorn 웹서버에서는 반환되지 않고 멈춘다.</p><p><code>python-bigquery</code> 라이브러리와 gunicorn 서버 사이에 호환성 문제가 있다는 확신이 들었다.</p><hr><h2 class="relative group">원인: gevent의 멍키패칭이 gRPC를 교착시킨다<div id=원인-gevent의-멍키패칭이-grpc를-교착시킨다 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%ec%9b%90%ec%9d%b8-gevent%ec%9d%98-%eb%a9%8d%ed%82%a4%ed%8c%a8%ec%b9%ad%ec%9d%b4-grpc%eb%a5%bc-%ea%b5%90%ec%b0%a9%ec%8b%9c%ed%82%a8%eb%8b%a4 aria-label=앵커>#</a></span></h2><h3 class="relative group">gunicorn의 워커 타입<div id=gunicorn의-워커-타입 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#gunicorn%ec%9d%98-%ec%9b%8c%ec%bb%a4-%ed%83%80%ec%9e%85 aria-label=앵커>#</a></span></h3><p>gunicorn은 여러 워커 타입을 지원한다. 우리가 사용하던 워커 타입은 <code>gevent</code>였다.</p><ul><li><strong>sync</strong>: 워커 하나가 요청 하나를 처리. 단순하지만 동시성이 낮다.</li><li><strong>gthread</strong>: 워커당 스레드 풀. Python의 네이티브 스레딩 사용.</li><li><strong>gevent</strong>: greenlet 기반 코루틴. 적은 리소스로 수천 개의 동시 커넥션을 처리할 수 있다.</li></ul><p>gevent는 높은 동시성을 제공하기 위해 특별한 방법을 쓴다. Python 프로세스가 시작될 때 표준 라이브러리의 I/O, 소켓, 스레딩 관련 모듈을 자체 구현으로 동적 교체한다. 이를 **멍키패칭(monkey patching)**이라고 한다. <code>import socket</code>을 하면 실제로는 gevent의 소켓이 로드되는 식이다.</p><h3 class="relative group">멍키패칭과 gRPC의 충돌<div id=멍키패칭과-grpc의-충돌 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%eb%a9%8d%ed%82%a4%ed%8c%a8%ec%b9%ad%ea%b3%bc-grpc%ec%9d%98-%ec%b6%a9%eb%8f%8c aria-label=앵커>#</a></span></h3><p>BigQuery Python SDK(<code>google-cloud-bigquery</code>)는 내부적으로 gRPC를 사용한다. gRPC는 C 코어 위에 Python 바인딩이 올라간 구조로, 네이티브 스레드를 사용한다.</p><p>문제는 gevent가 Python의 <code>concurrent.futures.ThreadPoolExecutor</code>를 멍키패칭할 때 발생한다. BigQuery SDK가 gRPC 호출 결과를 기다리면서 <code>ThreadPoolExecutor</code>를 사용하는데, gevent가 이 executor를 패칭한 버전은 gRPC의 네이티브 스레드와 호환되지 않는다. 결과적으로 gRPC 호출이 완료됐는데도 Python 쪽에서 결과를 받지 못하고 무한 대기한다.</p><p>이 문제가 새로운 것은 아니었다. <code>python-bigquery</code> 레포에는 과거에 <code>to_dataframe()</code> 메서드가 gevent 환경에서 블로킹되는 이슈가 보고됐었다. 해당 이슈는 해당 메서드에 한해 픽스됐지만, BigQuery SDK의 다른 gRPC 호출 경로에서도 동일한 문제가 발생한 것이다.</p><p>gevent의 GitHub에도, gRPC의 GitHub에도 관련 이슈가 열려 있다. gevent와 gRPC의 조합은 구조적으로 호환되기 어렵다.</p><h3 class="relative group">왜 Celery 워커는 괜찮은가<div id=왜-celery-워커는-괜찮은가 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%ec%99%9c-celery-%ec%9b%8c%ec%bb%a4%eb%8a%94-%ea%b4%9c%ec%b0%ae%ec%9d%80%ea%b0%80 aria-label=앵커>#</a></span></h3><p>Celery 워커는 gunicorn과 별개의 프로세스로 실행된다. 기본 설정에서 Celery 워커는 <code>prefork</code> 모드를 사용하는데, 이 모드에서는 gevent 멍키패칭이 적용되지 않는다. Python의 표준 스레딩이 그대로 동작하므로 gRPC와의 호환성 문제가 없다.</p><p>gunicorn 웹서버 프로세스에서만 gevent 멍키패칭이 적용되고, 그래서 웹서버에서만 블로킹이 발생했다.</p><hr><h2 class="relative group">해결: gevent에서 gthread로<div id=해결-gevent에서-gthread로 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%ed%95%b4%ea%b2%b0-gevent%ec%97%90%ec%84%9c-gthread%eb%a1%9c aria-label=앵커>#</a></span></h2><h3 class="relative group">워커 타입 교체<div id=워커-타입-교체 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%ec%9b%8c%ec%bb%a4-%ed%83%80%ec%9e%85-%ea%b5%90%ec%b2%b4 aria-label=앵커>#</a></span></h3><p>gunicorn의 워커 타입을 <code>gevent</code>에서 <code>gthread</code>로 교체했다.</p><p><code>gthread</code>는 Python의 네이티브 스레딩을 사용하는 워커 타입이다. 멍키패칭을 하지 않기 때문에 <code>concurrent.futures.ThreadPoolExecutor</code>와 gRPC가 정상적으로 동작한다.</p><p>교체 후 테스트 결과, 웹서버에서도 BigQuery 쿼리 로직이 블로킹 없이 정상 수행됐다. SqlLab, 차트 개발 화면, 강제 리프레시 모두 정상 동작을 확인했다.</p><h3 class="relative group">동시성 영향<div id=동시성-영향 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%eb%8f%99%ec%8b%9c%ec%84%b1-%ec%98%81%ed%96%a5 aria-label=앵커>#</a></span></h3><p>gevent에서 gthread로 바꾸면 동시성 특성이 달라진다. gevent는 greenlet 기반이라 적은 메모리로 수천 개의 동시 커넥션을 처리할 수 있지만, gthread는 OS 스레드 기반이라 동시 커넥션 수가 스레드 풀 크기에 제한된다.</p><p>우리 환경에서는 Superset 사용자 수가 동시 수천 커넥션 수준이 아니라서 gthread로도 충분했다. 워커당 스레드 수(<code>--threads</code>)를 적절히 설정하면 실질적인 동시성 차이는 크지 않다.</p><h3 class="relative group">업스트림 기여<div id=업스트림-기여 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%ec%97%85%ec%8a%a4%ed%8a%b8%eb%a6%bc-%ea%b8%b0%ec%97%ac aria-label=앵커>#</a></span></h3><p>이 경험을 바탕으로 Superset 공식 문서에 BigQuery 데이터소스 사용 시 gevent 워커를 사용하지 말라는 경고를 추가하는 PR을 제출해서 머지됐다. 동일한 문제로 시간을 낭비하는 사람이 줄어들면 좋겠다는 생각이었다.</p><p>커뮤니티 이슈 스레드에도 async 모드에서의 우회 방법과 gthread 교체를 통한 근본 해결을 공유했다.</p><hr><h2 class="relative group">Impersonation 관련 참고<div id=impersonation-관련-참고 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#impersonation-%ea%b4%80%eb%a0%a8-%ec%b0%b8%ea%b3%a0 aria-label=앵커>#</a></span></h2><p>BigQuery 연동에서 추가로 검토한 부분이 사용자별 권한 제어(impersonation)다. Superset에서 BigQuery에 접근할 때 서비스 계정 하나로 모든 쿼리를 실행하면 세밀한 권한 제어가 어렵다. 개별 사용자의 GCP 계정으로 쿼리를 실행하려면 impersonation 기능이 필요하다.</p><p>Superset 커뮤니티에서 BigQuery impersonation에 대한 논의와 OAuth2 기반 데이터베이스 인증 제안(SIP-85)이 진행되고 있다. 아직 완전한 형태로 구현되지는 않았지만, 향후 이 기능이 안정화되면 사용자별 BigQuery 권한 제어가 가능해진다.</p><hr><h2 class="relative group">배운 것<div id=배운-것 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%eb%b0%b0%ec%9a%b4-%ea%b2%83 aria-label=앵커>#</a></span></h2><p><strong>동일한 쿼리인데 실행 경로에 따라 결과가 다르면, 실행 환경의 차이를 의심하자.</strong> SqlLab은 Celery 워커, 차트는 gunicorn 웹서버에서 실행된다는 차이가 핵심이었다. &ldquo;같은 쿼리니까 같은 결과여야 한다"는 가정이 디버깅의 출발점을 잘못 잡게 만들 수 있다.</p><p><strong>gevent의 멍키패칭은 양날의 검이다.</strong> gevent가 높은 동시성을 제공하는 핵심 메커니즘이 멍키패칭인데, 이것이 gRPC처럼 네이티브 스레드에 의존하는 라이브러리와 충돌을 일으킨다. Python 생태계에서 gevent를 사용할 때는 디펜던시 중에 gRPC나 네이티브 스레딩에 의존하는 라이브러리가 있는지 확인해야 한다.</p><p><strong>워커 타입 선택은 디펜던시에 영향을 받는다.</strong> gunicorn 워커 타입을 선택할 때 동시성 요구사항만 보는 게 아니라, 어플리케이션이 사용하는 라이브러리의 스레딩 모델과 호환되는지도 확인해야 한다. BigQuery SDK + gRPC + gevent는 구조적으로 호환되지 않는다.</p><p><strong>커뮤니티 이슈 스레드를 끝까지 읽으면 실마리가 나온다.</strong> Superset 이슈 스레드에서 &ldquo;gunicorn 대신 waitress WSGI로 바꾸니 해결됐다"는 코멘트가 gevent 문제라는 방향을 잡는 데 결정적이었다. 이슈 스레드의 최신 코멘트까지 읽는 습관이 중요하다.</p><p><strong>문제를 해결했으면 업스트림에 기여하자.</strong> 문서 한 줄 추가하는 PR이라도 같은 문제를 겪을 사람의 시간을 절약해준다. 기여하는 데 드는 비용 대비 커뮤니티에 주는 가치가 크다.</p><p><strong>참고 자료:</strong></p><ul><li><a href=https://github.com/apache/superset/issues/23979 target=_blank rel=noreferrer>Superset: Unable to query BigQuery data</a></li><li><a href=https://github.com/googleapis/python-bigquery/issues/697 target=_blank rel=noreferrer>python-bigquery: to_dataframe blocked with gevent</a></li><li><a href=https://github.com/gevent/gevent/issues/1797 target=_blank rel=noreferrer>gevent: BigQuery to_dataframe blocking issue</a></li><li><a href=https://github.com/grpc/grpc/issues/4629 target=_blank rel=noreferrer>gRPC: gevent compatibility</a></li><li><a href=https://github.com/apache/superset/pull/24564 target=_blank rel=noreferrer>Superset docs: add notice not to use gevent with BigQuery</a></li><li><a href=https://github.com/apache/superset/discussions/18269 target=_blank rel=noreferrer>Superset: BigQuery impersonation discussion</a></li><li><a href=https://github.com/apache/superset/issues/20300 target=_blank rel=noreferrer>Superset: OAuth2 for databases (SIP-85)</a></li><li><a href=https://discuss.redash.io/t/big-query-does-not-show-schema/10649 target=_blank rel=noreferrer>Redash: BigQuery does not show schema</a></li><li><a href=https://gunicorn.org/design/ target=_blank rel=noreferrer>Gunicorn: Design / Server Model</a></li></ul></div><section class="flex flex-row flex-wrap justify-center pt-4 text-xl"><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://nanta-data.dev/posts/bigquery-bi-integration/&amp;title=Superset%ec%97%90%ec%84%9c%20BigQuery%ea%b0%80%20%eb%ac%b4%ed%95%9c%20%eb%b8%94%eb%a1%9c%ed%82%b9%eb%90%98%eb%8a%94%20%ec%9d%b4%ec%9c%a0:%20gevent%ec%99%80%20gRPC%ec%9d%98%20%ed%98%b8%ed%99%98%ec%84%b1%20%eb%ac%b8%ec%a0%9c" title="LinkedIn에서 공유" aria-label="LinkedIn에서 공유"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://reddit.com/submit/?url=https://nanta-data.dev/posts/bigquery-bi-integration/&amp;resubmit=true&amp;title=Superset%ec%97%90%ec%84%9c%20BigQuery%ea%b0%80%20%eb%ac%b4%ed%95%9c%20%eb%b8%94%eb%a1%9c%ed%82%b9%eb%90%98%eb%8a%94%20%ec%9d%b4%ec%9c%a0:%20gevent%ec%99%80%20gRPC%ec%9d%98%20%ed%98%b8%ed%99%98%ec%84%b1%20%eb%ac%b8%ec%a0%9c" title="Reddit에 게시" aria-label="Reddit에 게시"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M201.5 305.5c-13.8.0-24.9-11.1-24.9-24.6.0-13.8 11.1-24.9 24.9-24.9 13.6.0 24.6 11.1 24.6 24.9.0 13.6-11.1 24.6-24.6 24.6zM504 256c0 137-111 248-248 248S8 393 8 256 119 8 256 8s248 111 248 248zm-132.3-41.2c-9.4.0-17.7 3.9-23.8 10-22.4-15.5-52.6-25.5-86.1-26.6l17.4-78.3 55.4 12.5c0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.3 24.9-24.9s-11.1-24.9-24.9-24.9c-9.7.0-18 5.8-22.1 13.8l-61.2-13.6c-3-.8-6.1 1.4-6.9 4.4l-19.1 86.4c-33.2 1.4-63.1 11.3-85.5 26.8-6.1-6.4-14.7-10.2-24.1-10.2-34.9.0-46.3 46.9-14.4 62.8-1.1 5-1.7 10.2-1.7 15.5.0 52.6 59.2 95.2 132 95.2 73.1.0 132.3-42.6 132.3-95.2.0-5.3-.6-10.8-1.9-15.8 31.3-16 19.8-62.5-14.9-62.5zM302.8 331c-18.2 18.2-76.1 17.9-93.6.0-2.2-2.2-6.1-2.2-8.3.0-2.5 2.5-2.5 6.4.0 8.6 22.8 22.8 87.3 22.8 110.2.0 2.5-2.2 2.5-6.1.0-8.6-2.2-2.2-6.1-2.2-8.3.0zm7.7-75c-13.6.0-24.6 11.1-24.6 24.9.0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.1 24.9-24.6.0-13.8-11-24.9-24.9-24.9z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="mailto:?body=https://nanta-data.dev/posts/bigquery-bi-integration/&amp;subject=Superset%ec%97%90%ec%84%9c%20BigQuery%ea%b0%80%20%eb%ac%b4%ed%95%9c%20%eb%b8%94%eb%a1%9c%ed%82%b9%eb%90%98%eb%8a%94%20%ec%9d%b4%ec%9c%a0:%20gevent%ec%99%80%20gRPC%ec%9d%98%20%ed%98%b8%ed%99%98%ec%84%b1%20%eb%ac%b8%ec%a0%9c" title="이메일로 전송" aria-label="이메일로 전송"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></a></section></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span class="flex flex-col"><a class="flex text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" href=/posts/trino-alluxio-cache-poc/><span class=leading-6><span class="inline-block rtl:rotate-180">&larr;</span>&ensp;Trino Alluxio 캐시 PoC: EBS 스루풋이 병목이었다
</span></a><span class="ms-6 mt-1 text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2026-02-27T00:00:00+00:00>2026년 2월 27일</time>
</span></span><span class="flex flex-col items-end"><a class="flex text-right text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" href=/posts/superset-user-reported-issues/><span class=leading-6>Superset 사용자 제보 이슈 6건 대응기&ensp;<span class="inline-block rtl:rotate-180">&rarr;</span>
</span></a><span class="me-6 mt-1 text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2026-02-27T00:00:00+00:00>2026년 2월 27일</time></span></span></div></div></footer></article><div id=scroll-to-top class="fixed bottom-6 end-6 z-50 transform translate-y-4 opacity-0 duration-200"><a href=#the-top class="pointer-events-auto flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="맨 위로 스크롤" title="맨 위로 스크롤">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between text-sm text-neutral-500 dark:text-neutral-400"><nav><ul class="flex list-none flex-row"><li class="me-4 last:me-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href=/privacy-policy/ title=개인정보처리방침>개인정보처리방침</a></li></ul></nav><p>&copy;
2026
nanta</p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500" data-url=https://nanta-data.dev/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=검색 tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="닫기 (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>