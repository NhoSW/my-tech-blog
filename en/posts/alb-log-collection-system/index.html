<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>Building an ALB Log Pipeline with Filebeat, Flink, and Iceberg &#183; nanta - Data Engineering</title><meta name=title content="Building an ALB Log Pipeline with Filebeat, Flink, and Iceberg &#183; nanta - Data Engineering"><meta name=description content="We needed to turn CSV ALB logs sitting in S3 into a queryable Iceberg table. The first attempt with Flink's filesystem connector ran out of memory. This post covers the redesign with Filebeat + SQS + Kafka, autoscaling, checkpoint tuning, and the operational surprises we hit along the way."><meta name=keywords content="alb,filebeat,flink,iceberg,sqs,kafka,kubernetes,"><link rel=canonical href=https://nanta-data.dev/en/posts/alb-log-collection-system/><meta name=author content="nanta"><link href=https://github.com/NhoSW rel=me><meta property="og:url" content="https://nanta-data.dev/en/posts/alb-log-collection-system/"><meta property="og:site_name" content="nanta - Data Engineering"><meta property="og:title" content="Building an ALB Log Pipeline with Filebeat, Flink, and Iceberg"><meta property="og:description" content="We needed to turn CSV ALB logs sitting in S3 into a queryable Iceberg table. The first attempt with Flink’s filesystem connector ran out of memory. This post covers the redesign with Filebeat + SQS + Kafka, autoscaling, checkpoint tuning, and the operational surprises we hit along the way."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2026-02-25T00:00:00+00:00"><meta property="article:modified_time" content="2026-02-25T00:00:00+00:00"><meta property="article:tag" content="Alb"><meta property="article:tag" content="Filebeat"><meta property="article:tag" content="Flink"><meta property="article:tag" content="Iceberg"><meta property="article:tag" content="Sqs"><meta property="article:tag" content="Kafka"><meta name=twitter:card content="summary"><meta name=twitter:title content="Building an ALB Log Pipeline with Filebeat, Flink, and Iceberg"><meta name=twitter:description content="We needed to turn CSV ALB logs sitting in S3 into a queryable Iceberg table. The first attempt with Flink’s filesystem connector ran out of memory. This post covers the redesign with Filebeat + SQS + Kafka, autoscaling, checkpoint tuning, and the operational surprises we hit along the way."><link type=text/css rel=stylesheet href=/css/main.bundle.min.c14e86e0d9a09802d254d2a15c05847ae65bfc2e98c2166fabc67369d2d7f2eae6c1da03bbba58cfd41a4af802147c75ce9fdc11dd724ac627ab2903942cbb79.css integrity="sha512-wU6G4NmgmALSVNKhXAWEeuZb/C6YwhZvq8ZzadLX8urmwdoDu7pYz9QaSvgCFHx1zp/cEd1ySsYnqykDlCy7eQ=="><script type=text/javascript src=/js/appearance.min.6f41174b3a05b680820fe08cadbfa5fb7a7ca347b76a0955cdc68b9d8aca1ce24f0547e138cea33bcc7904d551a90afcb1cc7f2d9fe8557075d501419046c08c.js integrity="sha512-b0EXSzoFtoCCD+CMrb+l+3p8o0e3aglVzcaLnYrKHOJPBUfhOM6jO8x5BNVRqQr8scx/LZ/oVXB11QFBkEbAjA=="></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.bdda7dece6cbaf08deef7d254f7f842f3261c2524d247905127c9a20decc03f1011a2950048464c79272c1ce0705a49a41147f39f2b95163bb71d404b33263ef.js integrity="sha512-vdp97ObLrwje730lT3+ELzJhwlJNJHkFEnyaIN7MA/EBGilQBIRkx5Jywc4HBaSaQRR/OfK5UWO7cdQEszJj7w==" data-copy=Copy data-copied=Copied></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"Building an ALB Log Pipeline with Filebeat, Flink, and Iceberg","headline":"Building an ALB Log Pipeline with Filebeat, Flink, and Iceberg","inLanguage":"en","url":"https://nanta-data.dev/en/posts/alb-log-collection-system/","author":{"@type":"Person","name":"nanta"},"copyrightYear":"2026","dateCreated":"2026-02-25T00:00:00\u002b00:00","datePublished":"2026-02-25T00:00:00\u002b00:00","dateModified":"2026-02-25T00:00:00\u002b00:00","keywords":["alb","filebeat","flink","iceberg","sqs","kafka","kubernetes"],"mainEntityOfPage":"true","wordCount":"1453"}]</script><link rel=preconnect href=https://cdn.jsdelivr.net crossorigin><link href=https://cdn.jsdelivr.net/npm/geist@1.3.1/dist/fonts/geist-sans/style.min.css rel=stylesheet><link href=https://cdn.jsdelivr.net/npm/geist@1.3.1/dist/fonts/geist-mono/style.min.css rel=stylesheet><meta name=google-adsense-account content="ca-pub-9172052068678434"></head><body class="flex flex-col h-screen m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32 text-lg bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral bf-scrollbar"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 pe-2 dark:text-primary-400">&darr;</span>
Skip to main content</a></div><div class=min-h-[148px]></div><div class="fixed inset-x-0 z-100"><div id=menu-blur class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl bg-neutral/25 dark:bg-neutral-800/25"></div><div class="relative m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32"><div class="main-menu flex items-center w-full gap-2 p-1 pl-0"><a href=/en/ class="text-base font-medium truncate min-w-0 shrink">nanta - Data Engineering</a><div class="flex items-center ms-auto"><div class="hidden md:flex"><nav class="flex items-center gap-x-5 h-12"><a href=/en/posts/ class="flex items-center bf-icon-color-hover" aria-label=Posts title=Posts><span class="text-base font-medium break-normal">Posts
</span></a><a href=/en/categories/ class="flex items-center bf-icon-color-hover" aria-label=Categories title=Categories><span class="text-base font-medium break-normal">Categories
</span></a><a href=/en/tags/ class="flex items-center bf-icon-color-hover" aria-label=Tags title=Tags><span class="text-base font-medium break-normal">Tags
</span></a><a href=/en/about/ class="flex items-center bf-icon-color-hover" aria-label=About title=About><span class="text-base font-medium break-normal">About</span></a><div class="translation nested-menu"><button class="cursor-pointer flex items-center">
<span class=me-1><span class="relative block icon"><svg viewBox="0 0 640 512"><path fill="currentColor" d="M0 128C0 92.7 28.7 64 64 64H256h48 16H576c35.3.0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H320 304 256 64c-35.3.0-64-28.7-64-64V128zm320 0V384H576V128H320zM178.3 175.9c-3.2-7.2-10.4-11.9-18.3-11.9s-15.1 4.7-18.3 11.9l-64 144c-4.5 10.1.1 21.9 10.2 26.4s21.9-.1 26.4-10.2l8.9-20.1h73.6l8.9 20.1c4.5 10.1 16.3 14.6 26.4 10.2s14.6-16.3 10.2-26.4l-64-144zM160 233.2 179 276H141l19-42.8zM448 164c11 0 20 9 20 20v4h44 16c11 0 20 9 20 20s-9 20-20 20h-2l-1.6 4.5c-8.9 24.4-22.4 46.6-39.6 65.4.9.6 1.8 1.1 2.7 1.6l18.9 11.3c9.5 5.7 12.5 18 6.9 27.4s-18 12.5-27.4 6.9L467 333.8c-4.5-2.7-8.8-5.5-13.1-8.5-10.6 7.5-21.9 14-34 19.4l-3.6 1.6c-10.1 4.5-21.9-.1-26.4-10.2s.1-21.9 10.2-26.4l3.6-1.6c6.4-2.9 12.6-6.1 18.5-9.8L410 286.1c-7.8-7.8-7.8-20.5.0-28.3s20.5-7.8 28.3.0l14.6 14.6.5.5c12.4-13.1 22.5-28.3 29.8-45H448 376c-11 0-20-9-20-20s9-20 20-20h52v-4c0-11 9-20 20-20z"/></svg></span>
</span><span class="text-sm font-medium bf-icon-color-hover" title="Building an ALB Log Pipeline with Filebeat, Flink, and Iceberg">EN</span></button><ul class=menuhide><li class="rounded-xl backdrop-blur shadow-2xl p-2 flex flex-col gap-1"><a href=/posts/alb-log-collection-system/ class="flex items-center bf-icon-color-hover px-3 py-1"><span class="text-sm font-sm" title="ALB 로그를 Iceberg 테이블로 만들기까지">한국어
</span></a><a href=/en/posts/alb-log-collection-system/ class="flex items-center bf-icon-color-hover px-3 py-1"><span class="text-sm font-sm" title="Building an ALB Log Pipeline with Filebeat, Flink, and Iceberg">English</span></a></li></ul></div><button id=search-button aria-label=Search class="text-base bf-icon-color-hover" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base bf-icon-color-hover"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav></div><div class="flex md:hidden"><div class="flex items-center h-14 gap-4"><button id=search-button-mobile aria-label=Search class="flex items-center justify-center bf-icon-color-hover" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile type=button aria-label="Dark mode switcher" class="flex items-center justify-center text-neutral-900 hover:text-primary-600 dark:text-neutral-200 dark:hover:text-primary-400"><div class=dark:hidden><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="hidden dark:block"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button>
<input type=checkbox id=mobile-menu-toggle autocomplete=off class="hidden peer">
<label for=mobile-menu-toggle class="flex items-center justify-center cursor-pointer bf-icon-color-hover"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></label><div role=dialog aria-modal=true style=scrollbar-gutter:stable class="fixed inset-0 z-50 invisible overflow-y-auto px-6 py-20 opacity-0 transition-[opacity,visibility] duration-300 peer-checked:visible peer-checked:opacity-100 bg-neutral-50/97 dark:bg-neutral-900/99
bf-scrollbar"><label for=mobile-menu-toggle class="fixed end-8 top-5 flex items-center justify-center z-50 h-12 w-12 cursor-pointer select-none rounded-full bf-icon-color-hover border bf-border-color bf-border-color-hover bg-neutral-50 dark:bg-neutral-900"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></label><nav class="mx-auto max-w-md space-y-6"><div class=px-2><a href=/en/posts/ aria-label=Posts class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title=Posts class="text-2xl font-bold tracking-tight">Posts</span></a></div><div class=px-2><a href=/en/categories/ aria-label=Categories class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title=Categories class="text-2xl font-bold tracking-tight">Categories</span></a></div><div class=px-2><a href=/en/tags/ aria-label=Tags class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title=Tags class="text-2xl font-bold tracking-tight">Tags</span></a></div><div class=px-2><a href=/en/about/ aria-label=About class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title=About class="text-2xl font-bold tracking-tight">About</span></a></div><div class="flex flex-wrap items-center [&_span]:text-2xl [&_.translation_button_.icon]:text-4xl! [&_.translation_button_span]:text-base! [&_.translation_.menuhide_span]:text-sm! gap-x-6 ps-2 mt-8 pt-8 border-t bf-border-color"><div class="translation nested-menu"><button class="cursor-pointer flex items-center">
<span class=me-1><span class="relative block icon"><svg viewBox="0 0 640 512"><path fill="currentColor" d="M0 128C0 92.7 28.7 64 64 64H256h48 16H576c35.3.0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H320 304 256 64c-35.3.0-64-28.7-64-64V128zm320 0V384H576V128H320zM178.3 175.9c-3.2-7.2-10.4-11.9-18.3-11.9s-15.1 4.7-18.3 11.9l-64 144c-4.5 10.1.1 21.9 10.2 26.4s21.9-.1 26.4-10.2l8.9-20.1h73.6l8.9 20.1c4.5 10.1 16.3 14.6 26.4 10.2s14.6-16.3 10.2-26.4l-64-144zM160 233.2 179 276H141l19-42.8zM448 164c11 0 20 9 20 20v4h44 16c11 0 20 9 20 20s-9 20-20 20h-2l-1.6 4.5c-8.9 24.4-22.4 46.6-39.6 65.4.9.6 1.8 1.1 2.7 1.6l18.9 11.3c9.5 5.7 12.5 18 6.9 27.4s-18 12.5-27.4 6.9L467 333.8c-4.5-2.7-8.8-5.5-13.1-8.5-10.6 7.5-21.9 14-34 19.4l-3.6 1.6c-10.1 4.5-21.9-.1-26.4-10.2s.1-21.9 10.2-26.4l3.6-1.6c6.4-2.9 12.6-6.1 18.5-9.8L410 286.1c-7.8-7.8-7.8-20.5.0-28.3s20.5-7.8 28.3.0l14.6 14.6.5.5c12.4-13.1 22.5-28.3 29.8-45H448 376c-11 0-20-9-20-20s9-20 20-20h52v-4c0-11 9-20 20-20z"/></svg></span>
</span><span class="text-sm font-medium bf-icon-color-hover" title="Building an ALB Log Pipeline with Filebeat, Flink, and Iceberg">EN</span></button><ul class=menuhide><li class="rounded-xl backdrop-blur shadow-2xl p-2 flex flex-col gap-1"><a href=/posts/alb-log-collection-system/ class="flex items-center bf-icon-color-hover px-3 py-1"><span class="text-sm font-sm" title="ALB 로그를 Iceberg 테이블로 만들기까지">한국어
</span></a><a href=/en/posts/alb-log-collection-system/ class="flex items-center bf-icon-color-hover px-3 py-1"><span class="text-sm font-sm" title="Building an ALB Log Pipeline with Filebeat, Flink, and Iceberg">English</span></a></li></ul></div></div></nav></div></div></div></div></div></div></div><script type=text/javascript src=/js/background-blur.min.605b3b942818f0ab5a717ae446135ec46b8ee5a2ad12ae56fb90dc2a76ce30c388f9fec8bcc18db15bd47e3fa8a09d779fa12aa9c184cf614a315bc72c6c163d.js integrity="sha512-YFs7lCgY8KtacXrkRhNexGuO5aKtEq5W+5DcKnbOMMOI+f7IvMGNsVvUfj+ooJ13n6EqqcGEz2FKMVvHLGwWPQ==" data-blur-id=menu-blur></script><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class=hidden><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/en/>nanta - Data Engineering</a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/en/posts/>Posts</a><span class="px-1 text-primary-500">/</span></li><li class=hidden><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/en/posts/alb-log-collection-system/>Building an ALB Log Pipeline with Filebeat, Flink, and Iceberg</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Building an ALB Log Pipeline with Filebeat, Flink, and Iceberg</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2026-02-25T00:00:00+00:00>25 February 2026</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">7 mins</span></div></div><div class="flex author"><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">nanta</div><div class="text-sm text-neutral-700 dark:text-neutral-400">Data Engineering blog covering Apache Kafka, Airflow, Trino, StarRocks, and modern data infrastructure. Sharing practical lessons from production.</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/NhoSW target=_blank aria-label=Github title=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span></a></div></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ms-auto px-0 lg:order-last lg:ps-8 lg:max-w-2xs"><div class="toc ps-5 print:hidden lg:sticky lg:top-[140px]"><details open id=TOCView class="toc-right mt-0 overflow-y-auto overscroll-contain bf-scrollbar rounded-lg -ms-5 ps-5 pe-2 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="min-w-[220px] py-2 border-dotted border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#first-design-flink-filesystem-connector>First Design: Flink Filesystem Connector</a></li><li><a href=#current-architecture-s3--sqs--filebeat--kafka--flink--iceberg>Current Architecture: S3 → SQS → Filebeat → Kafka → Flink → Iceberg</a></li><li><a href=#how-we-ended-up-on-filebeat>How We Ended Up on Filebeat</a><ul><li><a href=#kafka-connect-filesystem-connector--abandoned>Kafka Connect Filesystem Connector — Abandoned</a></li><li><a href=#filebeat-bucket-listing-mode--cant-scale>Filebeat Bucket Listing Mode — Can&rsquo;t Scale</a></li><li><a href=#switching-to-sqs-mode>Switching to SQS Mode</a></li></ul></li><li><a href=#autoscaling>Autoscaling</a><ul><li><a href=#filebeat-sqs-based-keda-scaling>Filebeat: SQS-Based KEDA Scaling</a></li><li><a href=#flink-k8s-operator-autoscaling>Flink: K8s Operator Autoscaling</a></li></ul></li><li><a href=#flink-checkpoint-tuning>Flink Checkpoint Tuning</a><ul><li><a href=#heartbeat-timeout>Heartbeat Timeout</a></li><li><a href=#oom-java-heap-space>OOM: Java Heap Space</a></li><li><a href=#final-config>Final Config</a></li></ul></li><li><a href=#compaction-failures-and-dropping-upsert>Compaction Failures and Dropping Upsert</a></li><li><a href=#the-column-count-incident>The Column Count Incident</a><ul><li><a href=#first-fix-dead-letter-queue>First Fix: Dead Letter Queue</a></li><li><a href=#second-problem-dlq-topic-overload>Second Problem: DLQ Topic Overload</a></li></ul></li><li><a href=#deduplication-upsert-and-primary-keys>Deduplication: UPSERT and Primary Keys</a></li><li><a href=#monitoring>Monitoring</a><ul><li><a href=#key-metrics>Key Metrics</a></li><li><a href=#alerts>Alerts</a></li></ul></li><li><a href=#takeaways>Takeaways</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg -ms-5 ps-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#first-design-flink-filesystem-connector>First Design: Flink Filesystem Connector</a></li><li><a href=#current-architecture-s3--sqs--filebeat--kafka--flink--iceberg>Current Architecture: S3 → SQS → Filebeat → Kafka → Flink → Iceberg</a></li><li><a href=#how-we-ended-up-on-filebeat>How We Ended Up on Filebeat</a><ul><li><a href=#kafka-connect-filesystem-connector--abandoned>Kafka Connect Filesystem Connector — Abandoned</a></li><li><a href=#filebeat-bucket-listing-mode--cant-scale>Filebeat Bucket Listing Mode — Can&rsquo;t Scale</a></li><li><a href=#switching-to-sqs-mode>Switching to SQS Mode</a></li></ul></li><li><a href=#autoscaling>Autoscaling</a><ul><li><a href=#filebeat-sqs-based-keda-scaling>Filebeat: SQS-Based KEDA Scaling</a></li><li><a href=#flink-k8s-operator-autoscaling>Flink: K8s Operator Autoscaling</a></li></ul></li><li><a href=#flink-checkpoint-tuning>Flink Checkpoint Tuning</a><ul><li><a href=#heartbeat-timeout>Heartbeat Timeout</a></li><li><a href=#oom-java-heap-space>OOM: Java Heap Space</a></li><li><a href=#final-config>Final Config</a></li></ul></li><li><a href=#compaction-failures-and-dropping-upsert>Compaction Failures and Dropping Upsert</a></li><li><a href=#the-column-count-incident>The Column Count Incident</a><ul><li><a href=#first-fix-dead-letter-queue>First Fix: Dead Letter Queue</a></li><li><a href=#second-problem-dlq-topic-overload>Second Problem: DLQ Topic Overload</a></li></ul></li><li><a href=#deduplication-upsert-and-primary-keys>Deduplication: UPSERT and Primary Keys</a></li><li><a href=#monitoring>Monitoring</a><ul><li><a href=#key-metrics>Key Metrics</a></li><li><a href=#alerts>Alerts</a></li></ul></li><li><a href=#takeaways>Takeaways</a></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><p>The cloud infra team came to us with a request. They wanted ALB logs available as a queryable table for post-incident analysis.</p><p>ALB logs were already landing in S3 as CSV files. When someone needed them, they&rsquo;d query the files through Athena directly. Slow and painful. Text format meant query performance had a hard ceiling. Convert those logs to Parquet via Iceberg and you get something you can build a real-time dashboard on.</p><p>This post covers what we built and everything that went wrong along the way.</p><hr><h2 class="relative group">First Design: Flink Filesystem Connector<div id=first-design-flink-filesystem-connector class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#first-design-flink-filesystem-connector aria-label=Anchor>#</a></span></h2><p>We started with the simplest possible architecture.</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>S3 files → Flink (filesystem connector) → Iceberg table</span></span></code></pre></div></div><p>Flink&rsquo;s filesystem connector watches an S3 bucket. New file appears, connector reads it, emits each line as a record. Attach an Iceberg sink and you&rsquo;re done.</p><p>The problem was <strong>memory</strong>. The filesystem connector keeps the entire list of processed files in Flink state. ALB logs generate tens of thousands of files per day. State kept growing. Memory kept climbing. Eventually it crashed. We hit a scalability wall and had to rethink the architecture.</p><hr><h2 class="relative group">Current Architecture: S3 → SQS → Filebeat → Kafka → Flink → Iceberg<div id=current-architecture-s3--sqs--filebeat--kafka--flink--iceberg class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#current-architecture-s3--sqs--filebeat--kafka--flink--iceberg aria-label=Anchor>#</a></span></h2><p>We pulled file monitoring out of Flink. A message queue and a lightweight collector sit in front now.</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>S3 bucket → SQS (file events) → Filebeat → Kafka → Flink → Iceberg</span></span></code></pre></div></div><p>Each stage does one thing.</p><ol><li><strong>S3 → SQS</strong>: Bucket notification config pushes a message to SQS every time a new ALB log file lands</li><li><strong>SQS → Filebeat → Kafka</strong>: Filebeat consumes SQS messages, fetches the S3 file directly, and sends each line to a Kafka topic</li><li><strong>Kafka → Flink → Iceberg</strong>: Flink reads from Kafka, parses CSV, extracts metadata from the file path (account number, service name, role), and writes to an Iceberg table</li></ol><p>Flink only talks to Kafka now. No more file lists in state.</p><hr><h2 class="relative group">How We Ended Up on Filebeat<div id=how-we-ended-up-on-filebeat class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#how-we-ended-up-on-filebeat aria-label=Anchor>#</a></span></h2><p>We didn&rsquo;t start with Filebeat. We tried Kafka Connect Filesystem Connector first. That failed. Here&rsquo;s what happened.</p><h3 class="relative group">Kafka Connect Filesystem Connector — Abandoned<div id=kafka-connect-filesystem-connector--abandoned class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#kafka-connect-filesystem-connector--abandoned aria-label=Anchor>#</a></span></h3><p>This was a third-party connector with several problems.</p><ul><li>Not on Maven. Had to build from source</li><li>Last GitHub commit was 4 years old. Java 8 codebase</li><li>Messages were published more than once. Duplicate delivery with no clear fix</li><li>S3 file move (cleanup) didn&rsquo;t work. <code>FileUtil.copy()</code> breaks on S3A filesystems</li></ul><p>We decided that forcing an unmaintained tool to work was worse than picking something well-supported.</p><h3 class="relative group">Filebeat Bucket Listing Mode — Can&rsquo;t Scale<div id=filebeat-bucket-listing-mode--cant-scale class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#filebeat-bucket-listing-mode--cant-scale aria-label=Anchor>#</a></span></h3><p>Filebeat supports two modes for S3 input. We tried <strong>bucket listing mode</strong> first. It periodically scans S3 for new files.</p><p>It worked. But it couldn&rsquo;t scale horizontally. Multiple Filebeat instances would process the same files because they don&rsquo;t know about each other. The official docs say it explicitly: bucket listing mode means a single instance with vertical scaling only.</p><p>There was another issue. The backup feature (<code>backup_to_bucket_arn</code>) that moves processed files to a separate bucket didn&rsquo;t work in most Filebeat versions with bucket listing mode. A GitHub Issue showed the fix had been merged then accidentally reverted. Only version 8.15.3 worked correctly.</p><h3 class="relative group">Switching to SQS Mode<div id=switching-to-sqs-mode class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#switching-to-sqs-mode aria-label=Anchor>#</a></span></h3><p>SQS mode supports horizontal scaling. SQS handles message distribution, so multiple Filebeat pods process different files without overlap. S3 API costs go down too.</p><p>The tradeoff: no backfill of existing files. SQS mode only processes files that trigger events after setup. If you need historical files, you publish SQS events manually. Not a problem for our ALB log use case.</p><p>One more thing. SQS mode flat-out rejects <code>backup_to_bucket_arn</code>. Config validation fails at startup. Makes sense when you think about it — with SQS there&rsquo;s no need to separate new files from processed ones.</p><p>Final Filebeat config:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>filebeat.inputs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>aws-s3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>queue_url</span><span class=p>:</span><span class=w> </span><span class=l>https://sqs.ap-northeast-2.amazonaws.com/xxxx/s3-elb-logs-events</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>file_selectors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;.*\\.log\\.gz&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>number_of_workers</span><span class=p>:</span><span class=w> </span><span class=m>64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>decompress</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>codec.line</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>format</span><span class=p>:</span><span class=w> </span><span class=l>message</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>output.kafka</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>kafka-cluster:9092</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>topic</span><span class=p>:</span><span class=w> </span><span class=l>cloudinfra.prod.streaming.alb-access-log.csv</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>codec.format</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>string</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;%{[aws.s3.object.key]} %{[message]}&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>compression</span><span class=p>:</span><span class=w> </span><span class=l>zstd</span></span></span></code></pre></div></div><p>The key detail is <code>codec.format</code>. It prepends the S3 file path (<code>aws.s3.object.key</code>) to each message. Flink parses this path downstream to extract account numbers and service names.</p><hr><h2 class="relative group">Autoscaling<div id=autoscaling class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#autoscaling aria-label=Anchor>#</a></span></h2><h3 class="relative group">Filebeat: SQS-Based KEDA Scaling<div id=filebeat-sqs-based-keda-scaling class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#filebeat-sqs-based-keda-scaling aria-label=Anchor>#</a></span></h3><p>We configured a KEDA ScaledObject using SQS Visible Messages as the trigger.</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>cooldownPeriod</span><span class=p>:</span><span class=w> </span><span class=m>300</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>maxReplicaCount</span><span class=p>:</span><span class=w> </span><span class=m>128</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>minReplicaCount</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pollingInterval</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>triggers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>aws-sqs-queue</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>queueLength</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;50&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>queueURL</span><span class=p>:</span><span class=w> </span><span class=l>https://sqs.ap-northeast-2.amazonaws.com/xxxx/s3-elb-logs-events</span></span></span></code></pre></div></div><p>First attempt failed. KEDA&rsquo;s operator couldn&rsquo;t read SQS metrics due to IAM permissions. Setting <code>identityOwner: operator</code> in the ScaledObject makes KEDA use its own role instead of the pod&rsquo;s. We added <code>sqs:GetQueueAttributes</code> to that role and it worked.</p><h3 class="relative group">Flink: K8s Operator Autoscaling<div id=flink-k8s-operator-autoscaling class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#flink-k8s-operator-autoscaling aria-label=Anchor>#</a></span></h3><p>Flink uses the Kubernetes Operator&rsquo;s built-in autoscaler.</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>job.autoscaler.target.utilization</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0.75&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>job.autoscaler.target.utilization.boundary</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0.15&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>pipeline.max-parallelism</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;480&#39;</span></span></span></code></pre></div></div><hr><h2 class="relative group">Flink Checkpoint Tuning<div id=flink-checkpoint-tuning class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#flink-checkpoint-tuning aria-label=Anchor>#</a></span></h2><p>We bumped the checkpoint interval from 1 minute to 5 minutes. A chain of failures followed.</p><h3 class="relative group">Heartbeat Timeout<div id=heartbeat-timeout class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#heartbeat-timeout aria-label=Anchor>#</a></span></h3><p>Longer checkpoints meant TaskManagers couldn&rsquo;t send heartbeats in time. Default timeout was too short.</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>heartbeat.interval</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;60000&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>heartbeat.timeout</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;300000&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>pekko.ask.timeout</span><span class=p>:</span><span class=w> </span><span class=l>10m</span></span></span></code></pre></div></div><h3 class="relative group">OOM: Java Heap Space<div id=oom-java-heap-space class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#oom-java-heap-space aria-label=Anchor>#</a></span></h3><p>Longer checkpoint intervals meant more Kafka fetch data sitting in the heap. We bumped pod memory from 2G to 4G to 6G. Same crash every time.</p><p>The real problem: JVM Task Heap was only allocated 2.32GB even though the pod had plenty of memory overall. The Kafka fetch buffer filled that up. Fix was setting <code>taskmanager.memory.task.heap.size</code> explicitly.</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>taskmanager.memory.task.heap.size</span><span class=p>:</span><span class=w> </span><span class=l>4608m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>taskmanager.memory.managed.size</span><span class=p>:</span><span class=w> </span><span class=l>512m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>taskmanager.memory.network.fraction</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;0.02&#39;</span></span></span></code></pre></div></div><h3 class="relative group">Final Config<div id=final-config class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#final-config aria-label=Anchor>#</a></span></h3><p>After several rounds of tuning we got the checkpoint interval up to 10 minutes.</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>execution.checkpointing.interval</span><span class=p>:</span><span class=w> </span><span class=l>10m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>execution.checkpointing.timeout</span><span class=p>:</span><span class=w> </span><span class=l>5m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>heartbeat.interval</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;60000&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>heartbeat.timeout</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;300000&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>pekko.ask.timeout</span><span class=p>:</span><span class=w> </span><span class=l>10m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>taskmanager.memory.task.heap.size</span><span class=p>:</span><span class=w> </span><span class=l>4608m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>taskmanager.memory.managed.size</span><span class=p>:</span><span class=w> </span><span class=l>512m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>taskmanager.memory.network.fraction</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;0.02&#39;</span></span></span></code></pre></div></div><hr><h2 class="relative group">Compaction Failures and Dropping Upsert<div id=compaction-failures-and-dropping-upsert class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#compaction-failures-and-dropping-upsert aria-label=Anchor>#</a></span></h2><p>Even after the 10-minute checkpoint interval, Iceberg compaction kept failing. We decided to eliminate every suspected cause.</p><ol><li><strong>Created a new Iceberg table.</strong> The old table&rsquo;s metadata might have been in a bad state. Fresh table, clean start.</li><li><strong>Removed upsert logic.</strong> We&rsquo;d been using UPSERT mode to prevent duplicates. That was causing compaction conflicts.</li></ol><p>Dropping upsert means duplicates can appear. We checked. Duplicates did exist — but they weren&rsquo;t from the pipeline. The <strong>source ALB logs themselves had duplicates</strong>. We switched to append-only. Compaction started succeeding immediately.</p><hr><h2 class="relative group">The Column Count Incident<div id=the-column-count-incident class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#the-column-count-incident aria-label=Anchor>#</a></span></h2><p>One morning around 4 AM, Flink&rsquo;s CSV parsing started failing. ALB log columns had jumped from 31 to 34. AWS changed the format with no advance notice.</p><h3 class="relative group">First Fix: Dead Letter Queue<div id=first-fix-dead-letter-queue class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#first-fix-dead-letter-queue aria-label=Anchor>#</a></span></h3><p>We applied a csv-dlq format to route parse failures to a DLQ topic. The app recovered, but a new problem appeared. Format errors flooded the TaskManager logs. <strong>Ephemeral storage</strong> filled up. Pods got evicted in a loop.</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>The node was low on resource: ephemeral-storage.</span></span></code></pre></div></div><p>We fixed it by adjusting log4j to suppress format error logging.</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=na>logger.format.name</span> <span class=o>=</span> <span class=s>com.woowahan.dataservice.format</span>
</span></span><span class=line><span class=cl><span class=na>logger.format.level</span> <span class=o>=</span> <span class=s>ERROR</span></span></span></code></pre></div></div><h3 class="relative group">Second Problem: DLQ Topic Overload<div id=second-problem-dlq-topic-overload class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#second-problem-dlq-topic-overload aria-label=Anchor>#</a></span></h3><p>The DLQ topic received so many messages it put load on the entire Kafka cluster. We rolled back the DLQ approach and switched to <code>csv.ignore-parse-error</code> instead. Added 3 dummy columns to the source table definition so it accepts both 31-column and 34-column logs.</p><hr><h2 class="relative group">Deduplication: UPSERT and Primary Keys<div id=deduplication-upsert-and-primary-keys class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#deduplication-upsert-and-primary-keys aria-label=Anchor>#</a></span></h2><p>We initially used Iceberg UPSERT for deduplication. The challenge: ALB logs don&rsquo;t have a unique identifier.</p><p>We analyzed 467K log records and found that a combination of <code>file_path</code>, <code>time</code>, <code>http_request</code>, <code>client_addr</code>, <code>target_addr</code>, and <code>request_creation_time</code> was nearly unique. Only 1 duplicate existed across the entire dataset, and those 2 records were identical in every field — genuinely indistinguishable logs.</p><p>Setting a primary key in Iceberg required Flink SQL&rsquo;s <code>SET IDENTIFIER FIELDS</code>. Spark SQL doesn&rsquo;t support PRIMARY KEY syntax. Flink SQL doesn&rsquo;t support bucketing or hidden partitioning. Creating the table was harder than expected.</p><p>As described above, we ultimately dropped UPSERT for compaction stability.</p><hr><h2 class="relative group">Monitoring<div id=monitoring class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#monitoring aria-label=Anchor>#</a></span></h2><h3 class="relative group">Key Metrics<div id=key-metrics class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#key-metrics aria-label=Anchor>#</a></span></h3><table><thead><tr><th>Metric</th><th>What It Tells You</th></tr></thead><tbody><tr><td>SQS Approximate Number Of Messages Visible</td><td>Files waiting to be processed</td></tr><tr><td>SQS Approximate Number Of Messages Not Visible</td><td>Files Filebeat is currently processing</td></tr><tr><td>Kafka consumer lag</td><td>How far behind Flink is</td></tr><tr><td>Flink job status</td><td>Whether the app is running</td></tr></tbody></table><h3 class="relative group">Alerts<div id=alerts class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#alerts aria-label=Anchor>#</a></span></h3><ul><li>SQS: Visible Messages above threshold (backlog building up)</li><li>Filebeat: High CPU/memory usage, pod not running</li><li>Flink: Job transitions to non-running state</li></ul><hr><h2 class="relative group">Takeaways<div id=takeaways class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#takeaways aria-label=Anchor>#</a></span></h2><p>Three lessons stand out.</p><p><strong>Don&rsquo;t use Flink for file watching.</strong> The filesystem connector holds processed file lists in state. Run it long enough and memory blows up. Let SQS + Filebeat handle file discovery. Let Flink do what it&rsquo;s good at — stream processing.</p><p><strong>Upsert and compaction don&rsquo;t mix well.</strong> This is the Iceberg position delete problem. For log data, append-only is far more stable operationally. Handle source-level duplicates on the consumer side.</p><p><strong>AWS can change log formats without warning.</strong> ALB log columns went from 31 to 34 overnight. If your pipeline parses CSV, defensive options like <code>ignore-parse-error</code> aren&rsquo;t optional.</p><p><strong>References:</strong></p><ul><li><a href=https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-input-aws-s3.html target=_blank rel=noreferrer>Filebeat AWS S3 Input</a></li><li><a href=https://nightlies.apache.org/flink/flink-docs-release-1.19/docs/connectors/table/filesystem/ target=_blank rel=noreferrer>Flink Filesystem Connector</a></li><li><a href=https://iceberg.apache.org/docs/latest/flink-writes/ target=_blank rel=noreferrer>Apache Iceberg - Flink Writes</a></li><li><a href=https://keda.sh/docs/2.12/scalers/aws-sqs/ target=_blank rel=noreferrer>KEDA AWS SQS Queue Scaler</a></li></ul></div><section class="flex flex-row flex-wrap justify-center pt-4 text-xl"><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://nanta-data.dev/en/posts/alb-log-collection-system/&amp;title=Building%20an%20ALB%20Log%20Pipeline%20with%20Filebeat,%20Flink,%20and%20Iceberg" title="Share on LinkedIn" aria-label="Share on LinkedIn"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://reddit.com/submit/?url=https://nanta-data.dev/en/posts/alb-log-collection-system/&amp;resubmit=true&amp;title=Building%20an%20ALB%20Log%20Pipeline%20with%20Filebeat,%20Flink,%20and%20Iceberg" title="Submit to Reddit" aria-label="Submit to Reddit"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M201.5 305.5c-13.8.0-24.9-11.1-24.9-24.6.0-13.8 11.1-24.9 24.9-24.9 13.6.0 24.6 11.1 24.6 24.9.0 13.6-11.1 24.6-24.6 24.6zM504 256c0 137-111 248-248 248S8 393 8 256 119 8 256 8s248 111 248 248zm-132.3-41.2c-9.4.0-17.7 3.9-23.8 10-22.4-15.5-52.6-25.5-86.1-26.6l17.4-78.3 55.4 12.5c0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.3 24.9-24.9s-11.1-24.9-24.9-24.9c-9.7.0-18 5.8-22.1 13.8l-61.2-13.6c-3-.8-6.1 1.4-6.9 4.4l-19.1 86.4c-33.2 1.4-63.1 11.3-85.5 26.8-6.1-6.4-14.7-10.2-24.1-10.2-34.9.0-46.3 46.9-14.4 62.8-1.1 5-1.7 10.2-1.7 15.5.0 52.6 59.2 95.2 132 95.2 73.1.0 132.3-42.6 132.3-95.2.0-5.3-.6-10.8-1.9-15.8 31.3-16 19.8-62.5-14.9-62.5zM302.8 331c-18.2 18.2-76.1 17.9-93.6.0-2.2-2.2-6.1-2.2-8.3.0-2.5 2.5-2.5 6.4.0 8.6 22.8 22.8 87.3 22.8 110.2.0 2.5-2.2 2.5-6.1.0-8.6-2.2-2.2-6.1-2.2-8.3.0zm7.7-75c-13.6.0-24.6 11.1-24.6 24.9.0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.1 24.9-24.6.0-13.8-11-24.9-24.9-24.9z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="mailto:?body=https://nanta-data.dev/en/posts/alb-log-collection-system/&amp;subject=Building%20an%20ALB%20Log%20Pipeline%20with%20Filebeat,%20Flink,%20and%20Iceberg" title="Send via email" aria-label="Send via email"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></a></section></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span class="flex flex-col"><a class="flex text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" href=/en/posts/apisix-proxy-server-guide/><span class=leading-6><span class="inline-block rtl:rotate-180">&larr;</span>&ensp;Building a Proxy Server with Apache APISIX: De-identifying 1.3 Billion Daily Logs
</span></a><span class="ms-6 mt-1 text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2026-02-24T00:00:00+00:00>24 February 2026</time>
</span></span><span class="flex flex-col items-end"><a class="flex text-right text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" href=/en/posts/bigquery-bi-integration/><span class=leading-6>Why BigQuery Hangs in Superset: The gevent and gRPC Incompatibility&ensp;<span class="inline-block rtl:rotate-180">&rarr;</span>
</span></a><span class="me-6 mt-1 text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2026-02-27T00:00:00+00:00>27 February 2026</time></span></span></div></div></footer></article><div id=scroll-to-top class="fixed bottom-6 end-6 z-50 transform translate-y-4 opacity-0 duration-200"><a href=#the-top class="pointer-events-auto flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between text-sm text-neutral-500 dark:text-neutral-400"><nav><ul class="flex list-none flex-row"><li class="me-4 last:me-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href=/en/privacy-policy/ title="Privacy Policy">Privacy Policy</a></li></ul></nav><p>&copy;
2026
nanta</p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500" data-url=https://nanta-data.dev/en/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>